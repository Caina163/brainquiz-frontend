<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel - Criar Quiz</title>
  <style>
    body {
      background-color: #000;
      color: #0af;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
    }
    h2 {
      text-align: center;
      text-shadow: 0 0 10px #0af;
    }
    label {
      display: block;
      margin: 10px 0 5px;
    }
    input[type="text"], input[type="file"] {
      width: 100%;
      padding: 10px;
      border-radius: 5px;
      border: none;
      background-color: #111;
      color: #0af;
      box-shadow: inset 0 0 5px #0af;
      font-size: 1rem;
    }
    input[type="text"]:focus, input[type="file"]:focus {
      outline: none;
      background-color: #222;
      box-shadow: 0 0 10px #0af;
    }
    button {
      margin-top: 20px;
      padding: 12px;
      background-color: #0af;
      border: none;
      border-radius: 5px;
      color: #000;
      font-weight: bold;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: 0 0 10px #0af;
      transition: 0.3s;
      width: 100%;
    }
    button:hover {
      background-color: #08c;
      color: #fff;
      box-shadow: 0 0 20px #08c;
    }
    #successMessage {
      display: none;
      text-align: center;
      margin-top: 40px;
      color: #0af;
    }
    #backToStart {
      margin-top: 30px;
      color: #0af;
      cursor: pointer;
      text-decoration: underline;
      font-weight: bold;
      font-size: 1rem;
      display: inline-block;
    }
    #backToStart:hover {
      color: #0ff;
    }
    #questionsStep {
      display: none;
      max-width: 600px;
      margin: 0 auto;
    }
    .question-number {
      margin-bottom: 10px;
      text-align: center;
      font-weight: bold;
      color: #0ff;
    }
    .question-block {
      background: #111;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 0 8px #0af;
    }
    .question-block label {
      margin-top: 10px;
      display: block;
    }
    .question-block input[type="text"],
    .question-block input[type="file"] {
      width: 100%;
      padding: 8px;
      border-radius: 5px;
      border: none;
      background-color: #222;
      color: #0af;
      box-shadow: inset 0 0 5px #0af;
      font-size: 1rem;
      margin-top: 5px;
    }
    .question-block input[type="text"]:focus,
    .question-block input[type="file"]:focus {
      outline: none;
      background-color: #333;
      box-shadow: 0 0 10px #0af;
    }
    .alternatives {
      margin-top: 10px;
    }
    .alternative-input {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .alternative-input label {
      width: 60px;
      flex-shrink: 0;
      color: #0ff;
      font-weight: bold;
      margin: 0;
    }
    .alternative-input input[type="text"] {
      flex: 1;
      margin: 0;
    }
    .delete-alternative-btn {
      background-color: #c44;
      border: none;
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: bold;
      width: auto;
      margin: 0;
      flex-shrink: 0;
      transition: background-color 0.3s;
    }
    .delete-alternative-btn:hover {
      background-color: #a22;
    }
    .delete-alternative-btn:disabled {
      background-color: #666;
      cursor: not-allowed;
      opacity: 0.5;
    }
    .add-alternative-btn {
      margin-top: 10px;
      background-color: transparent;
      border: 1px solid #0af;
      color: #0af;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .add-alternative-btn:hover {
      background-color: #0af;
      color: #000;
    }
    #questionButtonsContainer {
      text-align: center;
      margin-bottom: 15px;
    }
    #questionButtonsContainer button {
      background-color: #0af;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      margin: 0 5px;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 8px #0af;
      transition: 0.3s;
      padding: 0;
    }
    #questionButtonsContainer button.active,
    #questionButtonsContainer button:hover {
      background-color: #08c;
      color: #fff;
      box-shadow: 0 0 15px #08c;
    }
    #quizImagePreview,
    #questionImagePreview {
      text-align: center;
      margin-bottom: 15px;
      width: 100%;
      max-width: 400px;
      max-height: 250px;
      margin-left: auto;
      margin-right: auto;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 15px #0af;
      background-color: #111;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    #quizImagePreview img,
    #questionImagePreview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 8px;
      display: block;
    }
    .remove-image-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      background-color: rgba(255, 0, 0, 0.8);
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 18px;
      line-height: 18px;
      text-align: center;
      padding: 0;
      user-select: none;
    }
    #deleteQuestionBtn {
      margin-top: 10px;
      background-color: #c00;
      color: #fff;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      font-weight: bold;
      font-size: 1rem;
      box-shadow: 0 0 10px #c00;
      transition: 0.3s;
    }
    #deleteQuestionBtn:hover {
      background-color: #a00;
      box-shadow: 0 0 20px #a00;
    }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    .error-message {
      color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      border: 1px solid #ff6b6b;
      text-align: center;
    }
    .alternative-input.correct-answer label {
      color: #0f0;
      text-shadow: 0 0 5px #0f0;
    }
    .back-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background-color: #666;
      color: #fff;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9rem;
      z-index: 1000;
      width: auto;
      margin: 0;
    }
    .back-btn:hover {
      background-color: #888;
    }
  </style>
</head>
<body>

  <!-- Bot√£o voltar para dashboard -->
  <button class="back-btn" onclick="voltarParaDashboard()">‚Üê Voltar ao Dashboard</button>

  <!-- Etapa 1: Criar Quiz -->
  <div id="quizInfoStep" style="max-width: 400px; margin: 0 auto;">
    <h2>Criar Novo Quiz</h2>

    <div id="quizImagePreview"></div>
    <label for="quizImage">Imagem do Quiz (PNG ou JPG) - opcional</label>
    <input type="file" id="quizImage" accept="image/png, image/jpeg" />

    <label for="quizTitle">T√≠tulo do Quiz</label>
    <input type="text" id="quizTitle" placeholder="Digite o t√≠tulo do quiz" required />

    <button id="startQuestionsBtn">Avan√ßar para Perguntas</button>
  </div>

  <!-- Etapa 2: Criar perguntas -->
  <div id="questionsStep">

    <div id="questionButtonsContainer"></div>

    <div class="question-number" id="questionNumberDisplay">Quest√£o 1</div>

    <div class="question-block" id="questionBlock">
      <div id="questionImagePreview"></div>
      <label for="questionImage">Imagem da Pergunta (PNG ou JPG) - opcional</label>
      <input type="file" id="questionImage" accept="image/png, image/jpeg" />

      <label for="questionText">Texto da Pergunta</label>
      <input type="text" id="questionText" placeholder="Digite a pergunta" required />

      <div class="alternatives">
        <label>Alternativas (primeira √© a correta)</label>

        <div class="alternative-input correct-answer">
          <label>Correta:</label>
          <input type="text" class="alternative" placeholder="Resposta correta" required />
          <button type="button" class="delete-alternative-btn" disabled title="N√£o √© poss√≠vel excluir a resposta correta">√ó</button>
        </div>

        <div class="alternative-input">
          <label>A:</label>
          <input type="text" class="alternative" placeholder="Alternativa" />
          <button type="button" class="delete-alternative-btn" onclick="excluirAlternativa(this)">√ó</button>
        </div>

        <div class="alternative-input">
          <label>B:</label>
          <input type="text" class="alternative" placeholder="Alternativa" />
          <button type="button" class="delete-alternative-btn" onclick="excluirAlternativa(this)">√ó</button>
        </div>
      </div>

      <button id="addAlternativeBtn" class="add-alternative-btn" type="button">+ Adicionar alternativa</button>
      <button id="nextQuestionBtn" style="margin-top: 15px;" type="button">Pr√≥xima pergunta</button>
      <button id="deleteQuestionBtn" type="button">Excluir pergunta</button>
      <button id="saveQuizBtn" style="margin-top: 15px; background-color: #0c0; color: #000;" type="button">Salvar Quiz</button>
    </div>
  </div>

  <!-- Mensagem de sucesso -->
  <div id="successMessage">
    <h2>üéâ Quiz criado com sucesso! üéâ</h2>
    <p>Redirecionando para o dashboard...</p>
    <div id="backToStart" tabindex="0">Voltar para o Dashboard</div>
  </div>

  <script>
    console.log('üöÄ PAINEL QUIZ v2.0 - Integra√ß√£o com Dashboard');

    const quizInfoStep = document.getElementById('quizInfoStep');
    const questionsStep = document.getElementById('questionsStep');
    const successMessage = document.getElementById('successMessage');
    const backToStart = document.getElementById('backToStart');
    const questionNumberDisplay = document.getElementById('questionNumberDisplay');
    const questionTextInput = document.getElementById('questionText');
    const questionImageInput = document.getElementById('questionImage');
    const alternativesContainer = document.querySelector('.alternatives');
    const addAlternativeBtn = document.getElementById('addAlternativeBtn');
    const nextQuestionBtn = document.getElementById('nextQuestionBtn');
    const saveQuizBtn = document.getElementById('saveQuizBtn');
    const deleteQuestionBtn = document.getElementById('deleteQuestionBtn');

    const quizImageInput = document.getElementById('quizImage');
    const quizImagePreview = document.getElementById('quizImagePreview');
    const questionImagePreview = document.getElementById('questionImagePreview');
    const questionButtonsContainer = document.getElementById('questionButtonsContainer');

    let quizData = {
      titulo: '',
      imagem: null,
      perguntas: []
    };

    let currentQuestionIndex = 0;
    let editingQuizId = null;

    // ============================================================================
    // VERIFICA√á√ÉO DE AUTENTICA√á√ÉO - NOVA
    // ============================================================================

    async function verificarAutenticacao() {
      try {
        const response = await fetch('/usuario', {
          method: 'GET',
          credentials: 'include'
        });
        
        if (!response.ok) {
          console.log('‚ùå Usu√°rio n√£o autenticado, redirecionando...');
          window.location.href = '/';
          return false;
        }
        
        const data = await response.json();
        if (!data.success || !data.usuario) {
          window.location.href = '/';
          return false;
        }
        
        console.log('‚úÖ Usu√°rio autenticado:', data.usuario.usuario);
        return data.usuario;
        
      } catch (error) {
        console.error('‚ùå Erro na verifica√ß√£o:', error);
        window.location.href = '/';
        return false;
      }
    }

    // ============================================================================
    // FUN√á√ïES DE MANIPULA√á√ÉO DE ALTERNATIVAS
    // ============================================================================

    function excluirAlternativa(botao) {
      const alternativeDiv = botao.parentElement;
      const todasAlternativas = document.querySelectorAll('.alternative-input');
      
      if (todasAlternativas.length <= 2) {
        alert('Voc√™ deve ter pelo menos uma alternativa al√©m da resposta correta.');
        return;
      }
      
      if (alternativeDiv.classList.contains('correct-answer')) {
        alert('N√£o √© poss√≠vel excluir a resposta correta.');
        return;
      }
      
      if (confirm('Excluir esta alternativa?')) {
        alternativeDiv.remove();
        atualizarLabelsAlternativas();
      }
    }

    function atualizarLabelsAlternativas() {
      const alternativas = document.querySelectorAll('.alternative-input');
      alternativas.forEach((div, index) => {
        const label = div.querySelector('label');
        if (index === 0) {
          label.textContent = 'Correta:';
        } else {
          label.textContent = String.fromCharCode(64 + index) + ':';
        }
      });
    }

    function adicionarNovaAlternativa() {
      const todasAlternativas = document.querySelectorAll('.alternative-input');
      const novoIndex = todasAlternativas.length;
      
      if (novoIndex >= 8) {
        alert('M√°ximo de 8 alternativas permitidas.');
        return;
      }

      const div = document.createElement('div');
      div.className = 'alternative-input';
      
      const label = document.createElement('label');
      label.textContent = String.fromCharCode(64 + novoIndex) + ':';
      
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'alternative';
      input.placeholder = 'Alternativa';
      
      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'delete-alternative-btn';
      deleteBtn.textContent = '√ó';
      deleteBtn.onclick = () => excluirAlternativa(deleteBtn);
      
      div.appendChild(label);
      div.appendChild(input);
      div.appendChild(deleteBtn);
      
      alternativesContainer.appendChild(div);
      input.focus();
    }

    addAlternativeBtn.addEventListener('click', adicionarNovaAlternativa);

    // ============================================================================
    // FUN√á√ïES DE MANIPULA√á√ÉO DE IMAGENS
    // ============================================================================

    function compressImage(file, maxWidth = 800, maxHeight = 600, quality = 0.8) {
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        
        img.onload = function() {
          let { width, height } = img;
          
          if (width > maxWidth || height > maxHeight) {
            const ratio = Math.min(maxWidth / width, maxHeight / height);
            width *= ratio;
            height *= ratio;
          }
          
          canvas.width = width;
          canvas.height = height;
          ctx.drawImage(img, 0, 0, width, height);
          
          const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
          resolve(compressedBase64);
        };
        
        img.src = URL.createObjectURL(file);
      });
    }

    function mostrarPreviewImagemBase64(base64, previewContainer, isQuiz = false) {
      previewContainer.innerHTML = `
        <div style="position:relative; display:inline-block; width: 100%; height: 100%;">
          <img src="${base64}" alt="Preview da imagem" />
          <button class="remove-image-btn" title="Remover imagem">√ó</button>
        </div>
      `;
      const btn = previewContainer.querySelector('.remove-image-btn');
      btn.addEventListener('click', () => {
        if (isQuiz) {
          quizImageInput.value = '';
          quizData.imagem = null;
        } else {
          questionImageInput.value = '';
          quizData.perguntas[currentQuestionIndex].imagem = null;
        }
        previewContainer.innerHTML = '';
      });
    }

    async function lerImagemComoBase64(fileInput, isQuiz, callback) {
      const file = fileInput.files[0];
      if (!file) {
        callback(null);
        return;
      }

      try {
        const container = isQuiz ? quizImagePreview : questionImagePreview;
        container.innerHTML = '<div style="color: #0af; padding: 20px;">Processando imagem...</div>';
        
        const compressedBase64 = await compressImage(file);
        
        if (compressedBase64.length > 1000000) {
          alert('Imagem muito grande. Tente uma imagem menor ou com menor resolu√ß√£o.');
          container.innerHTML = '';
          fileInput.value = '';
          callback(null);
          return;
        }
        
        if (isQuiz) {
          quizData.imagem = compressedBase64;
        } else {
          quizData.perguntas[currentQuestionIndex].imagem = compressedBase64;
        }
        
        callback(compressedBase64);
      } catch (error) {
        console.error('Erro ao processar imagem:', error);
        alert('Erro ao processar a imagem. Tente novamente.');
        const container = isQuiz ? quizImagePreview : questionImagePreview;
        container.innerHTML = '';
        fileInput.value = '';
        callback(null);
      }
    }

    // Event listeners para upload de imagens
    quizImageInput.addEventListener('change', async () => {
      await lerImagemComoBase64(quizImageInput, true, (base64) => {
        if (base64) {
          mostrarPreviewImagemBase64(base64, quizImagePreview, true);
        } else {
          quizImagePreview.innerHTML = '';
        }
      });
    });

    questionImageInput.addEventListener('change', async () => {
      await lerImagemComoBase64(questionImageInput, false, (base64) => {
        if (base64) {
          mostrarPreviewImagemBase64(base64, questionImagePreview, false);
        } else {
          questionImagePreview.innerHTML = '';
        }
      });
    });

    // ============================================================================
    // FUN√á√ïES DE GERENCIAMENTO DE PERGUNTAS
    // ============================================================================

    function limparFormularioPergunta() {
      questionTextInput.value = '';
      questionImageInput.value = '';
      questionImagePreview.innerHTML = '';

      const alternativesInputs = document.querySelectorAll('.alternative-input');
      alternativesInputs.forEach((div, i) => {
        if (i > 2) {
          div.remove();
        } else {
          div.querySelector('input').value = '';
        }
      });
    }

    function carregarQuestaoAtual() {
      questionNumberDisplay.textContent = `Quest√£o ${currentQuestionIndex + 1}`;
      limparFormularioPergunta();

      const pergunta = quizData.perguntas[currentQuestionIndex];
      if (pergunta) {
        questionTextInput.value = pergunta.texto || '';
        
        if (pergunta.imagem) {
          mostrarPreviewImagemBase64(pergunta.imagem, questionImagePreview, false);
        }

        const alternativesExistentes = document.querySelectorAll('.alternative-input');
        
        if (pergunta.alternativas && pergunta.alternativas.length > alternativesExistentes.length) {
          for (let i = alternativesExistentes.length; i < pergunta.alternativas.length; i++) {
            adicionarNovaAlternativa();
          }
        }

        const todasAlternativas = document.querySelectorAll('.alternative-input input');
        todasAlternativas.forEach((input, i) => {
          input.value = (pergunta.alternativas && pergunta.alternativas[i]) ? pergunta.alternativas[i] : '';
        });
      }

      atualizarBotaoAtivo();
      atualizarLabelsAlternativas();
      deleteQuestionBtn.style.display = quizData.perguntas.length > 1 ? 'block' : 'none';
    }

    function criarBotoesQuestoes() {
      questionButtonsContainer.innerHTML = '';
      quizData.perguntas.forEach((_, i) => {
        const btn = document.createElement('button');
        btn.textContent = i + 1;
        btn.type = 'button';
        btn.addEventListener('click', () => {
          salvarQuestaoAtual();
          currentQuestionIndex = i;
          carregarQuestaoAtual();
        });
        questionButtonsContainer.appendChild(btn);
      });
      atualizarBotaoAtivo();
    }

    function atualizarBotaoAtivo() {
      const buttons = questionButtonsContainer.querySelectorAll('button');
      buttons.forEach((btn, i) => {
        if (i === currentQuestionIndex) btn.classList.add('active');
        else btn.classList.remove('active');
      });
    }

    function salvarQuestaoAtual() {
      if (!quizData.perguntas[currentQuestionIndex]) {
        quizData.perguntas[currentQuestionIndex] = {
          texto: '',
          imagem: null,
          alternativas: [],
          resposta_certa: 0
        };
      }

      const pergunta = quizData.perguntas[currentQuestionIndex];
      pergunta.texto = questionTextInput.value.trim();

      const alternativesInputs = document.querySelectorAll('.alternative-input input');
      pergunta.alternativas = [];
      alternativesInputs.forEach(input => {
        pergunta.alternativas.push(input.value.trim());
      });

      pergunta.resposta_certa = 0;
    }

    // ============================================================================
    // EVENT LISTENERS PARA NAVEGA√á√ÉO
    // ============================================================================

    document.getElementById('startQuestionsBtn').addEventListener('click', () => {
      const titleInput = document.getElementById('quizTitle');
      if (!titleInput.value.trim()) {
        alert('Por favor, digite o t√≠tulo do quiz.');
        titleInput.focus();
        return;
      }

      quizData.titulo = titleInput.value.trim();

      if (quizData.perguntas.length === 0) {
        quizData.perguntas.push({
          texto: '',
          imagem: null,
          alternativas: ['', '', ''],
          resposta_certa: 0
        });
      }

      quizInfoStep.style.display = 'none';
      questionsStep.style.display = 'block';

      criarBotoesQuestoes();
      carregarQuestaoAtual();
    });

    nextQuestionBtn.addEventListener('click', () => {
      salvarQuestaoAtual();
      if (currentQuestionIndex === quizData.perguntas.length - 1) {
        quizData.perguntas.push({
          texto: '',
          imagem: null,
          alternativas: ['', '', ''],
          resposta_certa: 0
        });
        currentQuestionIndex++;
        criarBotoesQuestoes();
        carregarQuestaoAtual();
      } else {
        currentQuestionIndex++;
        carregarQuestaoAtual();
      }
    });

    deleteQuestionBtn.addEventListener('click', () => {
      if (quizData.perguntas.length <= 1) {
        alert('Voc√™ precisa ter pelo menos uma pergunta.');
        return;
      }

      if (confirm(`Excluir a pergunta ${currentQuestionIndex + 1}?`)) {
        quizData.perguntas.splice(currentQuestionIndex, 1);
        if (currentQuestionIndex >= quizData.perguntas.length) {
          currentQuestionIndex = quizData.perguntas.length - 1;
        }
        criarBotoesQuestoes();
        carregarQuestaoAtual();
      }
    });

    // ============================================================================
    // FUN√á√ÉO PRINCIPAL DE SALVAMENTO - CORRIGIDA PARA BACKEND
    // ============================================================================

    saveQuizBtn.addEventListener('click', async () => {
      try {
        saveQuizBtn.classList.add('loading');
        saveQuizBtn.textContent = 'Salvando...';
        
        salvarQuestaoAtual();

        // Valida√ß√µes
        if (!quizData.titulo || quizData.titulo.trim() === '') {
          alert('Por favor, defina um t√≠tulo para o quiz.');
          return;
        }

        if (!quizData.perguntas || quizData.perguntas.length === 0) {
          alert('Adicione pelo menos uma pergunta.');
          return;
        }

        // Validar cada pergunta
        for (let i = 0; i < quizData.perguntas.length; i++) {
          const p = quizData.perguntas[i];
          
          if (!p.texto || p.texto.trim() === '') {
            alert(`A pergunta ${i + 1} est√° vazia.`);
            currentQuestionIndex = i;
            carregarQuestaoAtual();
            return;
          }
          
          if (!p.alternativas || p.alternativas.length < 1) {
            alert(`A pergunta ${i + 1} deve ter pelo menos uma alternativa.`);
            currentQuestionIndex = i;
            carregarQuestaoAtual();
            return;
          }
          
          if (!p.alternativas[0] || p.alternativas[0].trim() === '') {
            alert(`A alternativa correta da pergunta ${i + 1} n√£o pode estar vazia.`);
            currentQuestionIndex = i;
            carregarQuestaoAtual();
            return;
          }
          
          const alternativasPreenchidas = p.alternativas.filter(alt => alt && alt.trim() !== '');
          if (alternativasPreenchidas.length < 2) {
            alert(`A pergunta ${i + 1} deve ter pelo menos uma alternativa al√©m da resposta correta.`);
            currentQuestionIndex = i;
            carregarQuestaoAtual();
            return;
          }
        }

        // ‚úÖ PREPARAR DADOS PARA O BACKEND
        const quizParaSalvar = {
          titulo: quizData.titulo,
          nome: quizData.titulo, // Campo que o dashboard espera
          imagem: quizData.imagem,
          imagemBase64: quizData.imagem, // Compatibilidade
          perguntas: quizData.perguntas.map(p => ({
            texto: p.texto.trim(),
            imagem: p.imagem,
            alternativas: p.alternativas.filter(alt => alt && alt.trim() !== ''),
            resposta_certa: 0 // Sempre primeira alternativa
          })),
          configuracoes: {
            criadoEm: new Date().toISOString(),
            editadoEm: new Date().toISOString()
          }
        };

        console.log('üì§ Enviando quiz para o backend:', quizParaSalvar);

        // ‚úÖ ENVIAR PARA O BACKEND
        const response = await fetch('/api/quizzes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify(quizParaSalvar)
        });

        const result = await response.json();

        if (response.ok && result.success) {
          console.log('‚úÖ Quiz salvo com sucesso no backend:', result);
          
          // ‚úÖ FALLBACK - Salvar tamb√©m no localStorage para compatibilidade
          try {
            let quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
            const quizFinal = {
              id: result.quiz?.id || Date.now(),
              nome: quizParaSalvar.nome,
              titulo: quizParaSalvar.titulo,
              imagem: quizParaSalvar.imagem,
              imagemBase64: quizParaSalvar.imagem,
              perguntas: quizParaSalvar.perguntas,
              ativo: true,
              arquivado: false,
              excluido: false,
              criadoEm: new Date().toISOString(),
              editadoEm: new Date().toISOString()
            };
            
            quizzes.push(quizFinal);
            localStorage.setItem('quizzes', JSON.stringify(quizzes));
            
            // Sinalizar para o dashboard que um novo quiz foi criado
            localStorage.setItem('novoQuizCriado', JSON.stringify({
              quiz: quizFinal,
              acao: 'criado',
              timestamp: Date.now()
            }));
            
            console.log('‚úÖ Quiz tamb√©m salvo no localStorage para compatibilidade');
          } catch (localError) {
            console.warn('‚ö†Ô∏è Erro ao salvar no localStorage:', localError);
          }
          
          // Mostrar sucesso e redirecionar
          questionsStep.style.display = 'none';
          successMessage.style.display = 'block';
          
          setTimeout(() => {
            voltarParaDashboard();
          }, 2000);
          
        } else {
          // Se o backend falhar, tentar salvar s√≥ no localStorage
          console.warn('‚ö†Ô∏è Backend falhou, salvando apenas no localStorage:', result);
          
          let quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
          const quizFinal = {
            id: Date.now(),
            nome: quizParaSalvar.nome,
            titulo: quizParaSalvar.titulo,
            imagem: quizParaSalvar.imagem,
            imagemBase64: quizParaSalvar.imagem,
            perguntas: quizParaSalvar.perguntas,
            ativo: true,
            arquivado: false,
            excluido: false,
            criadoEm: new Date().toISOString(),
            editadoEm: new Date().toISOString()
          };
          
          quizzes.push(quizFinal);
          localStorage.setItem('quizzes', JSON.stringify(quizzes));
          
          // Sinalizar para o dashboard
          localStorage.setItem('novoQuizCriado', JSON.stringify({
            quiz: quizFinal,
            acao: 'criado',
            timestamp: Date.now()
          }));
          
          console.log('‚úÖ Quiz salvo no localStorage como fallback');
          
          // Mostrar sucesso
          questionsStep.style.display = 'none';
          successMessage.style.display = 'block';
          
          setTimeout(() => {
            voltarParaDashboard();
          }, 2000);
        }

      } catch (error) {
        console.error('‚ùå Erro ao salvar quiz:', error);
        
        // ‚úÖ FALLBACK FINAL - Salvar no localStorage se tudo falhar
        try {
          let quizzes = JSON.parse(localStorage.getItem('quizzes') || '[]');
          const quizFinal = {
            id: Date.now(),
            nome: quizData.titulo,
            titulo: quizData.titulo,
            imagem: quizData.imagem,
            imagemBase64: quizData.imagem,
            perguntas: quizData.perguntas.map(p => ({
              texto: p.texto.trim(),
              imagem: p.imagem,
              alternativas: p.alternativas.filter(alt => alt && alt.trim() !== ''),
              resposta_certa: 0
            })),
            ativo: true,
            arquivado: false,
            excluido: false,
            criadoEm: new Date().toISOString(),
            editadoEm: new Date().toISOString()
          };
          
          quizzes.push(quizFinal);
          localStorage.setItem('quizzes', JSON.stringify(quizzes));
          
          localStorage.setItem('novoQuizCriado', JSON.stringify({
            quiz: quizFinal,
            acao: 'criado',
            timestamp: Date.now()
          }));
          
          console.log('‚úÖ Quiz salvo no localStorage como √∫ltimo recurso');
          
          questionsStep.style.display = 'none';
          successMessage.style.display = 'block';
          
          setTimeout(() => {
            voltarParaDashboard();
          }, 2000);
          
        } catch (fallbackError) {
          console.error('‚ùå Erro cr√≠tico - nem backend nem localStorage funcionaram:', fallbackError);
          alert('Erro cr√≠tico ao salvar quiz. Verifique sua conex√£o e tente novamente.');
        }
      } finally {
        saveQuizBtn.classList.remove('loading');
        saveQuizBtn.textContent = 'Salvar Quiz';
      }
    });

    // ============================================================================
    // FUN√á√ïES DE CARREGAMENTO PARA EDI√á√ÉO
    // ============================================================================

    function getUrlParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    async function carregarQuizParaEdicao(id) {
      try {
        console.log('üîß Carregando quiz para edi√ß√£o, ID:', id);
        
        // ‚úÖ TENTAR CARREGAR DO BACKEND PRIMEIRO
        try {
          const response = await fetch(`/api/quizzes/${id}`, {
            method: 'GET',
            credentials: 'include'
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.quiz) {
              console.log('‚úÖ Quiz carregado do backend:', data.quiz);
              preencherFormularioComQuiz(data.quiz, id);
              return;
            }
          }
        } catch (backendError) {
          console.warn('‚ö†Ô∏è Erro ao carregar do backend:', backendError);
        }
        
        // ‚úÖ FALLBACK - CARREGAR DO LOCALSTORAGE
        const quizzesData = JSON.parse(localStorage.getItem('quizzes') || '[]');
        const quiz = quizzesData.find(q => q.id == id);
        
        if (!quiz) {
          // ‚úÖ TENTAR CARREGAR DA COMUNICA√á√ÉO ENTRE P√ÅGINAS
          const quizParaEditar = localStorage.getItem('quizParaEditar');
          if (quizParaEditar) {
            const quiz = JSON.parse(quizParaEditar);
            console.log('‚úÖ Quiz carregado da comunica√ß√£o entre p√°ginas:', quiz);
            preencherFormularioComQuiz(quiz, quiz.id);
            localStorage.removeItem('quizParaEditar'); // Limpar ap√≥s usar
            return;
          }
          
          alert('Quiz n√£o encontrado!');
          voltarParaDashboard();
          return;
        }

        console.log('‚úÖ Quiz carregado do localStorage:', quiz);
        preencherFormularioComQuiz(quiz, id);
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar quiz para edi√ß√£o:', error);
        alert('Erro ao carregar quiz para edi√ß√£o.');
        voltarParaDashboard();
      }
    }

    function preencherFormularioComQuiz(quiz, id) {
      quizData = {
        titulo: quiz.titulo || quiz.nome || '',
        imagem: quiz.imagem || quiz.imagemBase64 || null,
        perguntas: quiz.perguntas || []
      };
      
      editingQuizId = id;

      // Preencher dados do quiz
      document.getElementById('quizTitle').value = quizData.titulo;
      if (quizData.imagem) {
        mostrarPreviewImagemBase64(quizData.imagem, quizImagePreview, true);
      }

      // Ir direto para a etapa de perguntas
      quizInfoStep.style.display = 'none';
      questionsStep.style.display = 'block';

      // Se n√£o tiver perguntas, criar uma vazia
      if (!quizData.perguntas || quizData.perguntas.length === 0) {
        quizData.perguntas = [{
          texto: '',
          imagem: null,
          alternativas: ['', '', ''],
          resposta_certa: 0
        }];
      }

      criarBotoesQuestoes();
      carregarQuestaoAtual();
      
      console.log('‚úÖ Formul√°rio preenchido com dados do quiz');
    }

    // ============================================================================
    // FUN√á√ïES DE NAVEGA√á√ÉO
    // ============================================================================

    function voltarParaDashboard() {
      console.log('üîÑ Redirecionando para dashboard...');
      // Como estamos em /painel.html, vamos para /dashboard.html
      window.location.href = '/dashboard.html';
    }

    backToStart.addEventListener('click', voltarParaDashboard);
    backToStart.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        voltarParaDashboard();
      }
    });

    // ============================================================================
    // INICIALIZA√á√ÉO
    // ============================================================================

    window.onload = async function() {
      console.log('üöÄ Inicializando Painel Quiz v2.0...');
      
      // ‚úÖ VERIFICAR AUTENTICA√á√ÉO PRIMEIRO
      const usuario = await verificarAutenticacao();
      if (!usuario) {
        return; // J√° redireciona para login
      }
      
      // ‚úÖ VERIFICAR SE EST√Å EDITANDO UM QUIZ
      const idEdit = getUrlParam('id');
      if (idEdit !== null) {
        console.log('üîß Modo edi√ß√£o - ID:', idEdit);
        await carregarQuizParaEdicao(idEdit);
      } else {
        console.log('üìù Modo cria√ß√£o - novo quiz');
        // Modo cria√ß√£o normal - n√£o precisa fazer nada especial
      }
      
      console.log('‚úÖ Painel inicializado com sucesso!');
    };

    // ============================================================================
    // FUN√á√ïES GLOBAIS
    // ============================================================================

    window.excluirAlternativa = excluirAlternativa;
    window.voltarParaDashboard = voltarParaDashboard;

    console.log('üéØ PAINEL QUIZ CARREGADO - v2.0 com Integra√ß√£o Backend!');
  </script>
</body>
</html>