<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üî• Quiz BrainQuiz - Jogue Agora</title>
  <style>
    body {
      background-color: #000;
      color: #0af;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      padding: 30px;
      margin: 0;
    }
    h1 {
      text-shadow: 0 0 10px #0af;
      margin-bottom: 10px;
    }
    .quiz-container {
      background-color: #111;
      border-radius: 10px;
      box-shadow: 0 0 20px #0af;
      padding: 20px 30px;
      max-width: 700px;
      width: 100%;
      position: relative;
    }
    .question {
      font-size: 1.4rem;
      margin-bottom: 15px;
    }
    .question img {
      max-width: 100%;
      max-height: 300px;
      object-fit: contain;
      margin-top: 10px;
      border-radius: 6px;
      box-shadow: 0 0 10px #0af;
      background: #000;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .answers {
      list-style: none;
      padding: 0;
      margin: 0 0 20px 0;
    }
    .answers li {
      background-color: #222;
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 10px;
      cursor: pointer;
      box-shadow: inset 0 0 5px #0af;
      transition: background-color 0.3s, box-shadow 0.3s;
      user-select: none;
    }
    .answers li:hover {
      background-color: #0af;
      color: #000;
      box-shadow: 0 0 15px #0af;
    }
    .answers li.selected {
      background-color: #08c;
      color: #fff;
      box-shadow: 0 0 20px #08c;
      font-weight: bold;
    }
    .answers li.correct {
      background-color: #90ee90;
      color: #000;
      box-shadow: 0 0 15px #0a0;
      cursor: default;
    }
    .answers li.wrong {
      background-color: #f08080;
      color: #000;
      box-shadow: 0 0 15px #a00;
      cursor: default;
    }
    button {
      background-color: #0af;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      color: #000;
      font-weight: bold;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: 0 0 20px #0af;
      transition: background-color 0.3s, box-shadow 0.3s;
    }
    button:hover {
      background-color: #08c;
      box-shadow: 0 0 30px #08c;
      color: #fff;
    }
    .score {
      font-size: 1.6rem;
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
    }
    #countdown {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 1.2rem;
      font-weight: bold;
      color: #0ff;
      user-select: none;
    }
    #result-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    #result-buttons button {
      min-width: 140px;
      padding: 12px 0;
    }
    .error-message {
      color: #ff6b6b;
      background: rgba(255, 107, 107, 0.1);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
      border: 2px solid #ff6b6b;
      text-align: center;
      font-size: 1.2rem;
    }
    .loading-message {
      text-align: center;
      font-size: 1.2rem;
      padding: 20px;
      color: #0af;
    }
    .voltar-inicio-btn {
      position: absolute;
      top: 15px;
      left: 20px;
      background: linear-gradient(135deg, #ff6b6b, #ff5252);
      color: white;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: bold;
      border-radius: 20px;
      border: none;
      cursor: pointer;
      box-shadow: 0 3px 12px rgba(255, 107, 107, 0.3);
      transition: all 0.3s ease;
      z-index: 1000;
      min-width: auto;
      opacity: 0.9;
    }
    .voltar-inicio-btn:hover {
      background: linear-gradient(135deg, #ff5252, #e53935);
      transform: translateY(-1px);
      box-shadow: 0 5px 18px rgba(255, 107, 107, 0.5);
      opacity: 1;
    }
    .voltar-inicio-btn:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>

  <h1>üß† BrainQuiz - Jogue Agora</h1>
  <div class="quiz-container" id="quiz-container">
    <div class="loading-message">üîÑ Carregando quiz...</div>
  </div>

  <script>
    console.log('%cüî• QUIZ CORRIGIDO - BACKEND INTEGRADO! üî•', 'color: #ff6b6b; font-size: 20px; font-weight: bold;');
    console.log('%cüìÅ Arquivo: quiz.html', 'color: #0af; font-size: 14px;');
    console.log('%c‚úÖ URLs corrigidas para produ√ß√£o!', 'color: #90ee90; font-size: 14px;');
    
    const quizContainer = document.getElementById('quiz-container');

    let quizAtual = null;
    let currentQuestionIndex = 0;
    let score = 0;
    let shuffledAlternatives = [];
    let countdownInterval = null;

    // üî• FUN√á√ÉO PRINCIPAL CORRIGIDA - Backend Integrado
    async function carregarQuizDoDashboard() {
      try {
        console.log('üîç Carregando quiz do backend...');

        // üî• M√âTODO 1: Tentar pegar quiz espec√≠fico do backend
        const urlParams = new URLSearchParams(window.location.search);
        const quizId = urlParams.get('id');
        
        if (quizId) {
          console.log('üîç Tentando carregar quiz por ID:', quizId);
          const quiz = await buscarQuizNoBackend(quizId);
          
          if (quiz && validarQuiz(quiz)) {
            iniciarQuiz(quiz);
            return;
          }
        }

        // üî• M√âTODO 2: Tentar carregar de dados tempor√°rios (dashboard)
        try {
          const response = await fetch('https://brainquiz-backend.onrender.com/api/quiz-temp', {
            method: 'GET',
            credentials: 'include'
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.success && data.quiz) {
              console.log('‚úÖ Quiz tempor√°rio encontrado no backend');
              if (validarQuiz(data.quiz)) {
                iniciarQuiz(data.quiz);
                return;
              }
            }
          }
        } catch (error) {
          console.warn('‚ö†Ô∏è Erro ao buscar quiz tempor√°rio:', error);
        }

        // üî• M√âTODO 3: Se nada funcionou, mostrar erro
        mostrarErro(
          '‚ùå Nenhum quiz selecionado', 
          'Volte ao dashboard e clique em um quiz para jogar.'
        );

      } catch (error) {
        console.error('‚ùå Erro ao carregar quiz:', error);
        mostrarErro('üí• Erro interno', 'Ocorreu um erro ao carregar o quiz. Tente recarregar a p√°gina.');
      }
    }

    // üî• FUN√á√ÉO NOVA - Buscar quiz no backend
    async function buscarQuizNoBackend(quizId) {
      try {
        const response = await fetch(`https://brainquiz-backend.onrender.com/api/quizzes/${quizId}`, {
          method: 'GET',
          credentials: 'include'
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.quiz) {
            console.log('‚úÖ Quiz carregado do backend:', data.quiz);
            return data.quiz;
          }
        }
        
        console.log('‚ùå Quiz n√£o encontrado no backend');
        return null;
      } catch (error) {
        console.error('‚ùå Erro ao buscar quiz no backend:', error);
        return null;
      }
    }

    // üî• FUN√á√ÉO NOVA - Validar estrutura do quiz
    function validarQuiz(quiz) {
      if (!quiz) {
        console.log('‚ùå Quiz √© null/undefined');
        return false;
      }

      if (!quiz.nome && !quiz.titulo) {
        console.log('‚ùå Quiz sem nome:', quiz);
        return false;
      }

      if (!quiz.perguntas || !Array.isArray(quiz.perguntas) || quiz.perguntas.length === 0) {
        console.log('‚ùå Quiz sem perguntas v√°lidas:', quiz);
        mostrarErro('üìù Quiz incompleto', `O quiz "${quiz.nome || quiz.titulo}" n√£o possui perguntas.`);
        return false;
      }

      // Validar cada pergunta
      const perguntasValidas = quiz.perguntas.filter(p => {
        if (!p || !p.texto) return false;
        
        // üî• COMPATIBILIDADE: Aceitar tanto 'opcoes' quanto 'alternativas'
        const opcoes = p.opcoes || p.alternativas;
        if (!opcoes || !Array.isArray(opcoes) || opcoes.length < 2) return false;
        
        // üî• COMPATIBILIDADE: Aceitar tanto 'respostaCorreta' quanto 'resposta_certa'
        const respostaCorreta = p.respostaCorreta !== undefined ? p.respostaCorreta : p.resposta_certa;
        if (typeof respostaCorreta !== 'number' || respostaCorreta < 0 || respostaCorreta >= opcoes.length) return false;
        
        return true;
      });

      if (perguntasValidas.length === 0) {
        mostrarErro('‚ö†Ô∏è Quiz com problemas', `O quiz "${quiz.nome || quiz.titulo}" tem perguntas mal formatadas.`);
        return false;
      }

      // Normalizar estrutura das perguntas
      quiz.perguntas = perguntasValidas.map(p => ({
        id: p.id || Date.now() + Math.random(),
        texto: p.texto,
        imagem: p.imagem || null,
        opcoes: p.opcoes || p.alternativas, // Padronizar para 'opcoes'
        respostaCorreta: p.respostaCorreta !== undefined ? p.respostaCorreta : p.resposta_certa,
        tempo: p.tempo || 30
      }));

      return true;
    }

    // üî• FUN√á√ÉO NOVA - Inicializar o quiz
    function iniciarQuiz(quiz) {
      quizAtual = quiz;
      currentQuestionIndex = 0;
      score = 0;

      console.log('‚úÖ Quiz carregado com sucesso:', {
        nome: quizAtual.nome || quizAtual.titulo,
        totalPerguntas: quizAtual.perguntas.length
      });

      // Atualizar t√≠tulo da p√°gina
      document.title = `Quiz: ${quizAtual.nome || quizAtual.titulo}`;
      document.querySelector('h1').textContent = `Quiz: ${quizAtual.nome || quizAtual.titulo}`;

      // Iniciar o jogo
      mostrarPergunta();
    }

    // üî• FUN√á√ÉO CORRIGIDA - Mostrar pergunta atual
    function mostrarPergunta() {
      clearInterval(countdownInterval);
      
      if (!quizAtual || !quizAtual.perguntas) {
        mostrarErro('‚ùå Erro no quiz', 'Dados do quiz corrompidos.');
        return;
      }

      const pergunta = quizAtual.perguntas[currentQuestionIndex];

      if (!pergunta) {
        mostrarErro('‚ùå Pergunta n√£o encontrada', `Erro na pergunta ${currentQuestionIndex + 1}.`);
        return;
      }

      // Filtrar alternativas v√°lidas (n√£o vazias)
      const opcoes = pergunta.opcoes.filter(opcao => opcao && opcao.trim() !== '');
      
      if (opcoes.length < 2) {
        mostrarErro('‚ö†Ô∏è Pergunta incompleta', `A pergunta ${currentQuestionIndex + 1} n√£o tem alternativas suficientes.`);
        return;
      }

      // Embaralhar alternativas mantendo refer√™ncia ao √≠ndice original
      const alternativas = opcoes.map((opcao, i) => ({
        texto: opcao,
        indiceOriginal: i
      }));

      shuffledAlternatives = shuffleArray([...alternativas]);

      // üî• HTML DA PERGUNTA COM BOT√ÉO "VOLTAR AO DASHBOARD" CORRIGIDO
      quizContainer.innerHTML = `
        <button class="voltar-inicio-btn" onclick="voltarAoDashboard()">üè† Voltar ao Dashboard</button>
        <div id="countdown"></div>
        <div class="question">
          <strong>Pergunta ${currentQuestionIndex + 1} de ${quizAtual.perguntas.length}</strong><br><br>
          ${pergunta.texto}
        </div>
        ${pergunta.imagem ? `<img src="${pergunta.imagem}" alt="Imagem da pergunta" />` : ''}
        <ul class="answers">
          ${shuffledAlternatives.map((alt, idx) => `<li data-index="${idx}">${alt.texto}</li>`).join('')}
        </ul>
        <button id="next-btn" disabled>Pr√≥xima Pergunta</button>
      `;

      const answerItems = quizContainer.querySelectorAll('.answers li');
      const nextBtn = document.getElementById('next-btn');
      const countdownEl = document.getElementById('countdown');
      let selectedAnswer = null;
      let answered = false;

      // üî• EVENTO CORRIGIDO - Sele√ß√£o da resposta
      answerItems.forEach(item => {
        item.addEventListener('click', () => {
          if (answered) return; // Evita m√∫ltiplos cliques

          answered = true;
          selectedAnswer = Number(item.getAttribute('data-index'));
          nextBtn.disabled = false;

          // Verificar resposta correta
          const respostaCorretaIndex = pergunta.respostaCorreta;
          const selectedOriginalIndex = shuffledAlternatives[selectedAnswer].indiceOriginal;

          console.log('üéØ Resposta selecionada:', {
            textoSelecionado: shuffledAlternatives[selectedAnswer].texto,
            indiceOriginalSelecionado: selectedOriginalIndex,
            respostaCorretaIndex: respostaCorretaIndex,
            acertou: selectedOriginalIndex === respostaCorretaIndex
          });

          // Marcar respostas visualmente
          answerItems.forEach((li, idx) => {
            li.style.pointerEvents = 'none'; // Bloquear cliques
            const originalIdx = shuffledAlternatives[idx].indiceOriginal;
            
            // Marcar resposta correta em verde
            if (originalIdx === respostaCorretaIndex) {
              li.classList.add('correct');
            }
            
            // Marcar resposta errada selecionada em vermelho
            if (idx === selectedAnswer && originalIdx !== respostaCorretaIndex) {
              li.classList.add('wrong');
            }
          });

          // Contar pontos
          if (selectedOriginalIndex === respostaCorretaIndex) {
            score++;
          }

          // Contagem regressiva para pr√≥xima pergunta
          let countdown = 3;
          countdownEl.textContent = `Pr√≥xima pergunta em ${countdown}s...`;
          countdownInterval = setInterval(() => {
            countdown--;
            if (countdown > 0) {
              countdownEl.textContent = `Pr√≥xima pergunta em ${countdown}s...`;
            } else {
              clearInterval(countdownInterval);
              proximaPergunta();
            }
          }, 1000);
        });
      });

      // Bot√£o "Pr√≥xima" manual
      nextBtn.addEventListener('click', () => {
        if (!answered) return;
        clearInterval(countdownInterval);
        proximaPergunta();
      });
    }

    // Embaralha array (Fisher-Yates)
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // üî• FUN√á√ÉO NOVA - Avan√ßar para pr√≥xima pergunta ou resultado
    function proximaPergunta() {
      currentQuestionIndex++;
      
      if (currentQuestionIndex < quizAtual.perguntas.length) {
        mostrarPergunta();
      } else {
        mostrarResultado();
      }
    }

    // üî• FUN√á√ÉO CORRIGIDA - Mostrar resultado final
    function mostrarResultado() {
      clearInterval(countdownInterval);
      
      const totalPerguntas = quizAtual.perguntas.length;
      const percentual = Math.round((score / totalPerguntas) * 100);
      
      let emoji = 'üòî';
      let mensagem = 'Que pena!';
      
      if (percentual >= 80) {
        emoji = 'üéâ';
        mensagem = 'Excelente!';
      } else if (percentual >= 60) {
        emoji = 'üòä';
        mensagem = 'Muito bom!';
      } else if (percentual >= 40) {
        emoji = 'üòê';
        mensagem = 'Pode melhorar!';
      }

      // üî• TELA DE RESULTADO COM BOT√ïES CORRIGIDOS
      quizContainer.innerHTML = `
        <div class="score">
          ${emoji}<br>
          <strong>${mensagem}</strong><br><br>
          Voc√™ acertou <strong>${score}</strong> de <strong>${totalPerguntas}</strong> perguntas<br>
          <span style="font-size: 1.2rem; color: #0ff;">(${percentual}% de acertos)</span>
        </div>
        <div id="result-buttons">
          <button id="restart-btn">üîÑ Jogar Novamente</button>
          <button id="back-to-dashboard-btn">üè† Voltar ao Dashboard</button>
        </div>
      `;

      // Eventos dos bot√µes
      document.getElementById('restart-btn').addEventListener('click', () => {
        currentQuestionIndex = 0;
        score = 0;
        mostrarPergunta();
      });

      document.getElementById('back-to-dashboard-btn').addEventListener('click', voltarAoDashboard);
    }

    // üî• FUN√á√ÉO NOVA - Mostrar erros de forma amig√°vel
    function mostrarErro(titulo, descricao) {
      quizContainer.innerHTML = `
        <div class="error-message">
          <h2>${titulo}</h2>
          <p>${descricao}</p>
          <div style="margin-top: 20px;">
            <button onclick="voltarAoDashboard()">üè† Voltar ao Dashboard</button>
          </div>
        </div>
      `;
    }

    // üî• FUN√á√ÉO CORRIGIDA - REDIRECIONAMENTO PARA NETLIFY
    function voltarAoDashboard() {
      console.log('üè† Redirecionando para o dashboard...');
      console.log('üéØ URL de destino: https://brainquiiz.netlify.app/dashboard.html');
      
      // üöÄ CORRE√á√ÉO PRINCIPAL: URL absoluta para Netlify
      window.location.href = 'https://brainquiiz.netlify.app/dashboard.html';
    }

    // üî• INICIALIZA√á√ÉO
    window.addEventListener('DOMContentLoaded', () => {
      console.log('üöÄ Iniciando sistema de quiz...');
      console.log('üìÅ Executando em: https://brainquiiz.netlify.app/quiz.html');
      carregarQuizDoDashboard();
    });

    // üî• DEBUG - Fun√ß√£o para testar no console
    window.debugQuiz = function() {
      console.log('üîç Debug do Quiz:', {
        quizAtual,
        currentQuestionIndex,
        score,
        caminhoAtual: window.location.pathname,
        urlCompleta: window.location.href
      });
    };

    console.log('‚úÖ Quiz.html CORRIGIDO carregado e pronto!');
    console.log('üîß Use debugQuiz() no console para debug');
    console.log('üéØ CORRE√á√ïES APLICADAS:');
    console.log('   ‚úì URLs corrigidas para Netlify/Render');
    console.log('   ‚úì Backend integrado');
    console.log('   ‚úì Redirecionamento absoluto');
    console.log('   ‚úì Todas as funcionalidades mantidas');
  </script>

</body>
</html>
