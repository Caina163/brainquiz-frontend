<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel Inicial - BrainQuiz</title>
  <style>
    body {
      background: linear-gradient(135deg, #000 0%, #1a1a2e 50%, #16213e 100%);
      color: #0af;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    /* Particles Animation */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }
    
    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: #0af;
      border-radius: 50%;
      animation: float 8s infinite linear;
      box-shadow: 0 0 10px #0af;
    }
    
    @keyframes float {
      0% {
        transform: translateY(100vh) translateX(0px);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-100px) translateX(100px);
        opacity: 0;
      }
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto 20px;
      background: rgba(17, 17, 17, 0.8);
      padding: 20px 30px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(0, 170, 255, 0.3);
      box-shadow: 0 0 30px rgba(0, 170, 255, 0.2);
    }
    
    h1 {
      margin: 0;
      text-shadow: 0 0 20px #0af;
      font-size: 2.5rem;
      animation: pulse 3s infinite;
    }

    @keyframes pulse {
      0%, 100% { text-shadow: 0 0 20px #0af; }
      50% { text-shadow: 0 0 40px #0af, 0 0 60px #0af; }
    }
    
    .header-buttons {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    #createQuizBtn, #exitBtn {
      background: linear-gradient(45deg, #0af, #08c);
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 5px 20px rgba(0, 170, 255, 0.3);
      transition: all 0.3s ease;
      display: inline-block;
    }
    
    #createQuizBtn:hover, #exitBtn:hover {
      background: linear-gradient(45deg, #08c, #0af);
      color: #fff;
      box-shadow: 0 8px 30px rgba(0, 170, 255, 0.6);
      transform: translateY(-3px);
    }
    
    #exitBtn {
      background: linear-gradient(45deg, #ff4444, #cc0000);
      box-shadow: 0 5px 20px rgba(255, 68, 68, 0.3);
    }
    
    #exitBtn:hover {
      background: linear-gradient(45deg, #cc0000, #ff4444);
      box-shadow: 0 8px 30px rgba(255, 68, 68, 0.6);
    }
    
    #tabs {
      max-width: 1200px;
      margin: 0 auto 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      background: rgba(17, 17, 17, 0.6);
      padding: 15px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 170, 255, 0.2);
    }
    
    .tab-button {
      background: rgba(34, 34, 34, 0.8);
      border: none;
      border-radius: 10px;
      padding: 12px 20px;
      color: #0af;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 170, 255, 0.2);
      font-weight: bold;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }
    
    .tab-button.active, .tab-button:hover {
      background: linear-gradient(45deg, #0af, #08c);
      color: #000;
      box-shadow: 0 8px 25px rgba(0, 170, 255, 0.4);
      transform: translateY(-2px);
    }
    
    #quizzesContainer {
      max-width: 1200px;
      margin: 0 auto;
      min-height: 200px;
    }
    
    .section-container {
      margin-bottom: 40px;
    }
    
    .section-title {
      color: #0af;
      font-size: 1.8rem;
      margin: 0 0 20px 0;
      text-shadow: 0 0 15px #0af;
      border-bottom: 3px solid #0af;
      padding-bottom: 10px;
      text-align: center;
      background: linear-gradient(90deg, transparent, rgba(0,170,255,0.1), transparent);
      padding: 15px;
      border-radius: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 170, 255, 0.3);
    }
    
    .section-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .items-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
      justify-content: center;
    }
    
    .empty-section {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 40px;
      background: rgba(0,170,255,0.05);
      border-radius: 10px;
      border: 2px dashed rgba(0,170,255,0.3);
      backdrop-filter: blur(5px);
    }

    .quiz-card, .user-card, .pdf-card, .perfil-card {
      background: rgba(17, 17, 17, 0.9);
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,170,255,0.2);
      padding: 20px;
      width: 280px;
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(0,170,255,0.3);
      backdrop-filter: blur(10px);
    }
    
    .quiz-card:hover, .user-card:hover, .pdf-card:hover, .perfil-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 35px rgba(0,170,255,0.4);
      border-color: #0af;
    }
    
    .quiz-title, .user-title, .pdf-card-name, .perfil-title {
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 15px;
      color: #0af;
      text-shadow: 0 0 5px rgba(0,170,255,0.5);
    }
    
    .quiz-image {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 15px;
      border: 2px solid rgba(0,170,255,0.3);
    }
    
    .user-photo {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(45deg, #0af, #08c);
      color: #000;
      font-weight: bold;
      font-size: 2rem;
      overflow: hidden;
      border: 3px solid rgba(0,170,255,0.5);
    }
    
    .user-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .user-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: bold;
      text-transform: uppercase;
    }
    
    .badge-administrador {
      background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
      color: #000;
    }
    
    .badge-moderador {
      background: linear-gradient(45deg, #ffa726, #ffcc02);
      color: #000;
    }
    
    .badge-aluno {
      background: linear-gradient(45deg, #66bb6a, #81c784);
      color: #000;
    }
    
    .gear-menu {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 35px;
      height: 35px;
      background: linear-gradient(45deg, #0af, #08c);
      border-radius: 50%;
      cursor: pointer;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0,170,255,0.4);
      transition: all 0.3s ease;
    }
    
    .gear-menu:hover {
      transform: rotate(90deg) scale(1.1);
      box-shadow: 0 6px 20px rgba(0,170,255,0.6);
    }
    
    .gear-menu::before {
      content: '⚙️';
      font-size: 16px;
    }
    
    .menu-options {
      display: none;
      position: absolute;
      top: 50px;
      right: 15px;
      background: rgba(26, 26, 26, 0.95);
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.8);
      padding: 10px;
      z-index: 30;
      min-width: 180px;
      border: 1px solid rgba(0,170,255,0.3);
      backdrop-filter: blur(10px);
    }
    
    .menu-options button {
      background: transparent;
      border: none;
      color: #0af;
      padding: 10px 15px;
      width: 100%;
      text-align: left;
      cursor: pointer;
      font-size: 0.9rem;
      border-radius: 6px;
      transition: all 0.2s ease;
      margin-bottom: 5px;
    }
    
    .menu-options button:hover:enabled {
      background: linear-gradient(45deg, #0af, #08c);
      color: #000;
      font-weight: bold;
    }
    
    .menu-options button:disabled {
      color: #555;
      cursor: not-allowed;
    }
    
    .menu-options button.danger {
      color: #ff4444;
    }
    
    .menu-options button.danger:hover:enabled {
      background: linear-gradient(45deg, #ff4444, #cc0000);
      color: #fff;
    }
    
    .empty-message {
      font-style: italic;
      color: #666;
      width: 100%;
      text-align: center;
      margin-top: 40px;
      padding: 40px;
      background: rgba(0,170,255,0.05);
      border-radius: 15px;
      border: 2px dashed rgba(0,170,255,0.2);
      backdrop-filter: blur(5px);
    }
    
    .loading {
      text-align: center;
      color: #0af;
      font-style: italic;
      padding: 40px;
      animation: pulse 2s infinite;
    }
    
    .error {
      color: #ff4444;
      background: rgba(255, 68, 68, 0.1);
      padding: 15px;
      border-radius: 10px;
      margin: 10px 0;
      border: 1px solid rgba(255, 68, 68, 0.3);
      backdrop-filter: blur(5px);
    }
    
    #mensagemSucesso {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #0af, #08c);
      color: #000;
      padding: 15px 25px;
      border-radius: 10px;
      font-weight: bold;
      box-shadow: 0 8px 25px rgba(0,170,255,0.4);
      z-index: 1000;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    #mensagemSucesso.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .user-actions {
      margin-top: 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .user-actions button {
      flex: 1 1 auto;
      background: linear-gradient(45deg, #0af, #08c);
      border: none;
      border-radius: 6px;
      padding: 8px 12px;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.85rem;
    }
    
    .user-actions button:hover:enabled {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0,170,255,0.4);
    }
    
    .user-actions button:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }
    
    .user-actions button.danger {
      background: linear-gradient(45deg, #ff4444, #cc0000);
      color: #fff;
    }

    /* PDF Card Styles */
    .pdf-card {
      cursor: default;
    }
    
    .pdf-icon {
      width: 100%;
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 4rem;
      color: #ff4444;
      background: rgba(255, 68, 68, 0.1);
      border-radius: 10px;
      margin-bottom: 15px;
      border: 2px solid rgba(255, 68, 68, 0.3);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .pdf-icon:hover {
      background: rgba(255, 68, 68, 0.2);
      transform: scale(1.05);
    }
    
    .pdf-status {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin: 10px 0;
      padding: 8px;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: bold;
    }
    
    .pdf-locked {
      background: rgba(255, 193, 7, 0.2);
      color: #ffc107;
      border: 1px solid rgba(255, 193, 7, 0.3);
    }
    
    .pdf-unlocked {
      background: rgba(40, 167, 69, 0.2);
      color: #28a745;
      border: 1px solid rgba(40, 167, 69, 0.3);
    }

    /* Upload Button */
    .upload-btn {
      background: linear-gradient(45deg, #28a745, #20c997);
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
      transition: all 0.3s ease;
    }
    
    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.6);
    }

    /* Calendar Styles */
    .calendar-container {
      background: rgba(17, 17, 17, 0.9);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 25px rgba(0,170,255,0.2);
      border: 1px solid rgba(0,170,255,0.3);
      backdrop-filter: blur(10px);
      overflow-x: auto;
    }

    .calendar-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 0.9rem;
    }

    .calendar-table th,
    .calendar-table td {
      padding: 12px 15px;
      text-align: center;
      border: 2px solid rgba(0, 170, 255, 0.3);
    }

    .calendar-table th {
      background: linear-gradient(45deg, #0af, #08c);
      color: #000;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .calendar-table td {
      background: rgba(34, 34, 34, 0.8);
      color: #0af;
    }

    .period-header {
      background: linear-gradient(45deg, #ffa726, #ffcc02) !important;
      color: #000 !important;
      font-weight: bold;
    }

    .current-period {
      background: linear-gradient(45deg, #28a745, #20c997) !important;
      color: #fff !important;
      font-weight: bold;
      animation: glow 2s infinite alternate;
      position: relative;
    }

    .current-period::after {
      content: " 👈 ATUAL";
      font-size: 0.8rem;
      margin-left: 10px;
    }

    .future-period {
      background: rgba(68, 68, 68, 0.5);
      color: #999;
    }

    .past-period {
      background: rgba(255, 68, 68, 0.1);
      color: #ff6b6b;
    }

    .completion-info {
      background: linear-gradient(45deg, #0af, #08c) !important;
      color: #000 !important;
      font-weight: bold;
    }

    @keyframes glow {
      from { box-shadow: 0 0 20px rgba(40, 167, 69, 0.6); }
      to { box-shadow: 0 0 30px rgba(40, 167, 69, 0.9); }
    }

    .status-legend {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: bold;
    }

    .legend-current {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: #fff;
    }

    .legend-future {
      background: rgba(68, 68, 68, 0.5);
      color: #ccc;
    }

    .legend-past {
      background: rgba(255, 68, 68, 0.2);
      color: #ff6b6b;
    }

    /* Profile Edit Styles */
    .perfil-form {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(17, 17, 17, 0.9);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 25px rgba(0,170,255,0.2);
      border: 1px solid rgba(0,170,255,0.3);
      backdrop-filter: blur(10px);
    }
    
    .perfil-form h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #0af;
      text-shadow: 0 0 10px rgba(0,170,255,0.5);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #0af;
      font-weight: bold;
    }
    
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      background: rgba(34, 34, 34, 0.8);
      border: 2px solid rgba(0,170,255,0.3);
      border-radius: 8px;
      color: #0af;
      font-size: 1rem;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #0af;
      box-shadow: 0 0 10px rgba(0,170,255,0.3);
      background: rgba(51, 51, 51, 0.9);
    }
    
    .photo-upload {
      text-align: center;
      margin-bottom: 25px;
    }
    
    .current-photo {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(45deg, #0af, #08c);
      color: #000;
      font-weight: bold;
      font-size: 3rem;
      overflow: hidden;
      border: 4px solid rgba(0,170,255,0.5);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .current-photo:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(0,170,255,0.4);
    }
    
    .current-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .save-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(45deg, #0af, #08c);
      border: none;
      border-radius: 8px;
      color: #000;
      font-weight: bold;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 10px;
    }
    
    .save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,170,255,0.4);
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      backdrop-filter: blur(5px);
    }
    
    .modal-content {
      background: rgba(17, 17, 17, 0.95);
      margin: 5% auto;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0,170,255,0.3);
      border: 2px solid rgba(0,170,255,0.3);
      position: relative;
      backdrop-filter: blur(10px);
    }
    
    .close {
      position: absolute;
      right: 20px;
      top: 15px;
      color: #0af;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    
    .close:hover {
      color: #ff4444;
    }
    
    .modal h3 {
      color: #0af;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .modal input, .modal select {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      background: rgba(34, 34, 34, 0.8);
      border: 2px solid rgba(0,170,255,0.3);
      border-radius: 8px;
      color: #0af;
      box-sizing: border-box;
    }
    
    .modal-buttons {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }
    
    .modal-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-confirm {
      background: linear-gradient(45deg, #0af, #08c);
      color: #000;
    }
    
    .btn-cancel {
      background: linear-gradient(45deg, #666, #555);
      color: #fff;
    }

    /* PDF Viewer Modal */
    .pdf-viewer-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.9);
      backdrop-filter: blur(5px);
    }

    .pdf-viewer-content {
      background: rgba(17, 17, 17, 0.95);
      margin: 2% auto;
      padding: 20px;
      border-radius: 15px;
      width: 95%;
      height: 90%;
      max-width: 1200px;
      box-shadow: 0 10px 30px rgba(0,170,255,0.3);
      border: 2px solid rgba(0,170,255,0.3);
      position: relative;
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
    }

    .pdf-viewer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid rgba(0,170,255,0.3);
    }

    .pdf-viewer-header h3 {
      color: #0af;
      margin: 0;
    }

    .pdf-frame {
      flex: 1;
      border: 2px solid rgba(0,170,255,0.3);
      border-radius: 10px;
      background: #fff;
    }
    
    @media (max-width: 768px) {
      .items-grid {
        justify-content: center;
      }
      
      .quiz-card, .user-card, .pdf-card {
        width: 90%;
        max-width: 350px;
      }
      
      #tabs {
        justify-content: center;
      }
      
      .section-title {
        flex-direction: column;
        gap: 15px;
      }

      header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }

      .header-buttons {
        justify-content: center;
      }

      .calendar-container {
        padding: 15px;
      }

      .calendar-table {
        font-size: 0.8rem;
      }

      .calendar-table th,
      .calendar-table td {
        padding: 8px 6px;
      }

      .status-legend {
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="particles"></div>
  
  <header>
    <h1>🧠 BrainQuiz - Painel</h1>
    <div class="header-buttons">
      <button id="createQuizBtn" title="Criar novo quiz">📝 Criar Quiz</button>
      <button id="exitBtn" title="Sair do sistema">🚪 Sair</button>
    </div>
  </header>
  
  <div id="tabs">
    <button class="tab-button active" data-tab="ativos">🎯 Quizzes Ativos</button>
    <button class="tab-button" data-tab="arquivados">📁 Arquivados</button>
    <button class="tab-button" data-tab="excluidos">🗑️ Excluídos</button>
    <button class="tab-button" data-tab="usuarios">👥 Usuários</button>
    <button class="tab-button" data-tab="cadastros">⏳ Cadastros Pendentes</button>
    <button class="tab-button" data-tab="pdfs">📄 PDFs</button>
    <button class="tab-button" data-tab="calendario">📅 Calendário</button>
    <button class="tab-button" data-tab="perfil">👤 Meu Perfil</button>
  </div>

  <main id="mainContainer">
    <div id="quizzesContainer"></div>
  </main>

  <div id="mensagemSucesso"></div>

  <!-- PDF Viewer Modal -->
  <div id="pdfViewerModal" class="pdf-viewer-modal">
    <div class="pdf-viewer-content">
      <div class="pdf-viewer-header">
        <h3 id="pdfViewerTitle">Visualizar PDF</h3>
        <span class="close" onclick="closePdfViewer()">&times;</span>
      </div>
      <iframe id="pdfFrame" class="pdf-frame" src=""></iframe>
    </div>
  </div>

  <!-- Modais -->
  <div id="editUserModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>✏️ Editar Usuário</h3>
      <input type="text" id="editUserName" placeholder="Nome">
      <input type="text" id="editUserEmail" placeholder="Email">
      <input type="text" id="editUserPhone" placeholder="Telefone">
      <select id="editUserType">
        <option value="aluno">Aluno</option>
        <option value="moderador">Moderador</option>
        <option value="administrador">Administrador</option>
      </select>
      <div class="modal-buttons">
        <button class="btn-confirm" onclick="saveUserEdit()">💾 Salvar</button>
        <button class="btn-cancel" onclick="closeModal('editUserModal')">❌ Cancelar</button>
      </div>
    </div>
  </div>

  <div id="changePasswordModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>🔑 Alterar Senha</h3>
      <input type="password" id="newPassword" placeholder="Nova senha">
      <input type="password" id="confirmPassword" placeholder="Confirmar senha">
      <div class="modal-buttons">
        <button class="btn-confirm" onclick="changeUserPassword()">🔄 Alterar</button>
        <button class="btn-cancel" onclick="closeModal('changePasswordModal')">❌ Cancelar</button>
      </div>
    </div>
  </div>

  <div id="profilePasswordModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>🔐 Confirmar Senha</h3>
      <p style="color: #0af; margin-bottom: 20px;">Digite sua senha atual para salvar as alterações:</p>
      <input type="password" id="currentPassword" placeholder="Senha atual">
      <div class="modal-buttons">
        <button class="btn-confirm" onclick="confirmProfileSave()">✅ Confirmar</button>
        <button class="btn-cancel" onclick="closeModal('profilePasswordModal')">❌ Cancelar</button>
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" accept=".pdf" style="display: none;">
  <input type="file" id="profilePhotoInput" accept="image/*" style="display: none;">

<script>
console.log('🚀 DASHBOARD SINCRONIZADO v5.1 - Sistema Real com Backend');

// ============================================================================
// VARIABLES GLOBAIS - SISTEMA REAL
// ============================================================================

let usuarioLogado = null;
let users = [];
let cadastros = [];
let quizzes = [];
let quizzesArquivados = [];
let quizzesExcluidos = [];
let pdfs = [];
let pdfsExcluidos = [];
let currentTab = 'ativos';
let currentEditingUser = null;
let pendingProfileData = null;

const quizzesContainer = document.getElementById('quizzesContainer');
const createQuizBtn = document.getElementById('createQuizBtn');
const exitBtn = document.getElementById('exitBtn');
const mensagemSucesso = document.getElementById('mensagemSucesso');

// ============================================================================
// EFEITOS VISUAIS - MANTIDOS TODOS
// ============================================================================

function criarParticulas() {
  const container = document.querySelector('.particles');
  
  setInterval(() => {
    const particle = document.createElement('div');
    particle.className = 'particle';
    particle.style.left = Math.random() * 100 + 'vw';
    particle.style.animationDelay = Math.random() * 2 + 's';
    container.appendChild(particle);
    
    setTimeout(() => {
      if (particle.parentNode) {
        particle.parentNode.removeChild(particle);
      }
    }, 8000);
  }, 500);
}

// ============================================================================
// SISTEMA DE AUTENTICAÇÃO REAL - CORRIGIDO
// ============================================================================

async function verificarUsuarioLogado() {
  console.log('🔍 Verificando sessão do usuário...');
  
  try {
    // Verificar sessão no backend
    const response = await fetch('/usuario', {
      method: 'GET',
      credentials: 'include'
    });
    
    if (response.ok) {
      const data = await response.json();
      if (data.success && data.usuario) {
        usuarioLogado = data.usuario;
        console.log('✅ Usuário autenticado:', usuarioLogado.usuario);
        return true;
      }
    }
    
    // Se chegou aqui, não está autenticado
    console.log('❌ Usuário não autenticado, redirecionando...');
    window.location.href = '/';
    return false;
    
  } catch (error) {
    console.error('❌ Erro ao verificar sessão:', error);
    window.location.href = '/';
    return false;
  }
}

// ============================================================================
// CARREGAMENTO DE DADOS REAIS DO BACKEND - CORRIGIDO
// ============================================================================

async function carregarDadosReais() {
  console.log('📡 Carregando dados reais do backend...');
  
  try {
    // Carregar usuários
    const usuariosResponse = await fetch('/api/usuarios', {
      method: 'GET',
      credentials: 'include'
    });
    
    if (usuariosResponse.ok) {
      const usuariosData = await usuariosResponse.json();
      users = usuariosData.usuarios || [];
      console.log('✅ Usuários carregados:', users.length);
    }
    
    // Carregar cadastros pendentes
    const cadastrosResponse = await fetch('/api/cadastros', {
      method: 'GET',
      credentials: 'include'
    });
    
    if (cadastrosResponse.ok) {
      const cadastrosData = await cadastrosResponse.json();
      cadastros = cadastrosData.cadastros || [];
      console.log('✅ Cadastros pendentes:', cadastros.length);
    }
    
    // Carregar quizzes ativos
    const quizzesResponse = await fetch('/api/quizzes', {
      method: 'GET',
      credentials: 'include'
    });
    
    if (quizzesResponse.ok) {
      const quizzesData = await quizzesResponse.json();
      quizzes = quizzesData.quizzes || [];
      console.log('✅ Quizzes ativos:', quizzes.length);
    }
    
    // Carregar quizzes arquivados (só admin/moderador)
    if (usuarioLogado.tipo === 'administrador' || usuarioLogado.tipo === 'moderador') {
      const arquivadosResponse = await fetch('/api/quizzes/arquivados', {
        method: 'GET',
        credentials: 'include'
      });
      
      if (arquivadosResponse.ok) {
        const arquivadosData = await arquivadosResponse.json();
        quizzesArquivados = arquivadosData.quizzes || [];
        console.log('✅ Quizzes arquivados:', quizzesArquivados.length);
      }
    }
    
    // Carregar quizzes excluídos (só admin)
    if (usuarioLogado.tipo === 'administrador') {
      const excluidosResponse = await fetch('/api/quizzes/excluidos', {
        method: 'GET',
        credentials: 'include'
      });
      
      if (excluidosResponse.ok) {
        const excluidosData = await excluidosResponse.json();
        quizzesExcluidos = excluidosData.quizzes || [];
        console.log('✅ Quizzes excluídos:', quizzesExcluidos.length);
      }
    }
    
    // Carregar PDFs
    const pdfsResponse = await fetch('/api/pdfs', {
      method: 'GET',
      credentials: 'include'
    });
    
    if (pdfsResponse.ok) {
      const pdfsData = await pdfsResponse.json();
      pdfs = pdfsData.pdfs || [];
      console.log('✅ PDFs carregados:', pdfs.length);
    }
    
    console.log('✅ Todos os dados carregados com sucesso');
    
  } catch (error) {
    console.error('❌ Erro ao carregar dados:', error);
    mostrarMensagemSucesso('⚠️ Erro ao carregar alguns dados. Tentando novamente...');
  }
}

// ============================================================================
// CONFIGURAÇÃO DOS BOTÕES PRINCIPAIS - CORRIGIDA
// ============================================================================

function configurarBotoesPrincipais() {
  console.log('⚙️ Configurando botões principais...');
  
  const podecriarQuiz = validarPermissao('criar_quiz');
  
  if (podecriarQuiz) {
    createQuizBtn.style.display = 'inline-block';
    createQuizBtn.onclick = () => {
      console.log('🔄 Redirecionando para criação de quiz...');
      window.location.href = '/painel.html';
    };
  } else {
    createQuizBtn.style.display = 'none';
  }

  // BOTÃO SAIR CORRIGIDO - SEMPRE USA BACKEND
  exitBtn.onclick = async () => {
    if (confirm('Deseja realmente sair do sistema?')) {
      console.log('👋 Fazendo logout...');
      
      try {
        // Fazer logout no backend
        const response = await fetch('/logout', {
          method: 'POST',
          credentials: 'include'
        });
        
        if (response.ok) {
          console.log('✅ Logout realizado no backend');
        }
      } catch (error) {
        console.error('⚠️ Erro no logout backend:', error);
      }
      
      // Limpar qualquer localStorage (compatibilidade)
      localStorage.clear();
      
      // Redirecionar para index.html
      console.log('🔄 Redirecionando para index.html...');
      window.location.href = '/';
    }
  };
}

// ============================================================================
// SISTEMA DE PERMISSÕES - MANTIDO COMPLETO
// ============================================================================

function validarPermissao(acao) {
  if (!usuarioLogado) {
    return false;
  }
  
  const permissoes = {
    'criar_quiz': ['administrador', 'moderador'],
    'editar_quiz': ['administrador', 'moderador'],
    'arquivar_quiz': ['administrador', 'moderador'],
    'excluir_quiz': ['administrador'],
    'gerenciar_usuarios': ['administrador', 'moderador'],
    'editar_usuarios': ['administrador', 'moderador'],
    'alterar_senhas': ['administrador', 'moderador'],
    'promover_rebaixar': ['administrador'],
    'excluir_usuarios': ['administrador'],
    'ver_excluidos': ['administrador'],
    'ver_arquivados': ['administrador'],
    'upload_pdf': ['administrador', 'moderador'],
    'gerenciar_pdfs': ['administrador'],
    'download_pdf_bloqueado': ['administrador', 'moderador'],
  };
  
  return permissoes[acao]?.includes(usuarioLogado.tipo) || false;
}

// ============================================================================
// CONFIGURAÇÃO DAS ABAS - MANTIDA COMPLETA
// ============================================================================

function configurarTabs() {
  const tabUsuarios = document.querySelector('[data-tab="usuarios"]');
  const tabCadastros = document.querySelector('[data-tab="cadastros"]');
  const tabArquivados = document.querySelector('[data-tab="arquivados"]');
  const tabExcluidos = document.querySelector('[data-tab="excluidos"]');
  const tabCalendario = document.querySelector('[data-tab="calendario"]');
  
  // Calendário sempre visível para todos os tipos de usuário
  tabCalendario.style.display = 'inline-block';
  
  if (usuarioLogado.tipo === 'aluno') {
    tabUsuarios.style.display = 'none';
    tabCadastros.style.display = 'none';
    tabArquivados.style.display = 'none';
    tabExcluidos.style.display = 'none';
  } else if (usuarioLogado.tipo === 'moderador') {
    tabUsuarios.style.display = 'inline-block';
    tabCadastros.style.display = 'inline-block';
    tabArquivados.style.display = 'none';
    tabExcluidos.style.display = 'none';
  } else if (usuarioLogado.tipo === 'administrador') {
    tabUsuarios.style.display = 'inline-block';
    tabCadastros.style.display = 'inline-block';
    tabArquivados.style.display = 'inline-block';
    tabExcluidos.style.display = 'inline-block';
  }

  const tabs = document.querySelectorAll('.tab-button');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const tabName = tab.getAttribute('data-tab');
      
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentTab = tabName;
      exibirConteudo();
    });
  });
}

// ============================================================================
// DADOS DO CALENDÁRIO ACADÊMICO - MANTIDOS COMPLETOS
// ============================================================================

const calendarioAcademico = [
  { periodo: '1º', modulo: 'A', fase: 'Fase 1', dataEstimada: 'Jan - Fev 2025', observacoes: 'Início do curso' },
  { periodo: '', modulo: 'A', fase: 'Fase 2', dataEstimada: 'Mar - Abr 2025', observacoes: '' },
  { periodo: '', modulo: 'B', fase: 'Fase 1', dataEstimada: 'Mai - Jun 2025', observacoes: '' },
  { periodo: '2º', modulo: 'B', fase: 'Fase 2', dataEstimada: 'Jul - Ago 2025', observacoes: 'Você entrará no 2º período aqui' },
  { periodo: '', modulo: 'C', fase: 'Fase 1', dataEstimada: 'Set - Out 2025', observacoes: '' },
  { periodo: '', modulo: 'C', fase: 'Fase 2', dataEstimada: 'Nov - Dez 2025', observacoes: '' },
  { periodo: '3º', modulo: 'A', fase: 'Fase 1', dataEstimada: 'Jan - Fev 2026', observacoes: 'Você entrará no 3º período aqui' },
  { periodo: '', modulo: 'A', fase: 'Fase 2', dataEstimada: 'Mar - Abr 2026', observacoes: '' },
  { periodo: '', modulo: 'B', fase: 'Fase 1', dataEstimada: 'Mai - Jun 2026', observacoes: '' },
  { periodo: '4º', modulo: 'B', fase: 'Fase 2', dataEstimada: 'Jul - Ago 2026', observacoes: 'Você entrará no 4º período aqui' },
  { periodo: '', modulo: 'C', fase: 'Fase 1', dataEstimada: 'Set - Out 2026', observacoes: '' },
  { periodo: '', modulo: 'C', fase: 'Fase 2', dataEstimada: 'Nov - Dez 2026', observacoes: '' },
  { periodo: '5º', modulo: 'A', fase: 'Fase 1', dataEstimada: 'Jan - Fev 2027', observacoes: 'Você entrará no 5º período aqui' },
  { periodo: '', modulo: 'A', fase: 'Fase 2', dataEstimada: 'Mar - Abr 2027', observacoes: '' },
  { periodo: '', modulo: 'B', fase: 'Fase 1', dataEstimada: 'Mai - Jun 2027', observacoes: '' },
  { periodo: '6º', modulo: 'B', fase: 'Fase 2', dataEstimada: 'Jul - Ago 2027', observacoes: 'Você entrará no 6º período aqui' },
  { periodo: '', modulo: 'C', fase: 'Fase 1', dataEstimada: 'Set - Out 2027', observacoes: '' },
  { periodo: '', modulo: 'C', fase: 'Fase 2', dataEstimada: 'Nov - Dez 2027', observacoes: '' },
  { periodo: '7º', modulo: 'A', fase: 'Fase 1', dataEstimada: 'Jan - Fev 2028', observacoes: 'Você entrará no 7º período aqui' },
  { periodo: '', modulo: 'A', fase: 'Fase 2', dataEstimada: 'Mar - Abr 2028', observacoes: '' },
  { periodo: '', modulo: 'B', fase: 'Fase 1', dataEstimada: 'Mai - Jun 2028', observacoes: '' },
  { periodo: '8º', modulo: 'B', fase: 'Fase 2', dataEstimada: 'Jul - Ago 2028', observacoes: 'Você entrará no 8º período aqui' },
  { periodo: '', modulo: 'C', fase: 'Fase 1', dataEstimada: 'Set - Out 2028', observacoes: '' },
  { periodo: '', modulo: 'C', fase: 'Fase 2', dataEstimada: 'Nov - Dez 2028', observacoes: 'Fim das disciplinas' },
  { periodo: '', modulo: '', fase: '', dataEstimada: '', observacoes: 'Formatura em 2029' }
];

function determinarPeriodoAtual() {
  const agora = new Date();
  const ano = agora.getFullYear();
  const mes = agora.getMonth() + 1;
  
  if (ano === 2025) {
    if (mes >= 1 && mes <= 2) return 0;
    if (mes >= 3 && mes <= 4) return 1;
    if (mes >= 5 && mes <= 6) return 2;
    if (mes >= 7 && mes <= 8) return 3;
    if (mes >= 9 && mes <= 10) return 4;
    if (mes >= 11 && mes <= 12) return 5;
  }
  
  return 0;
}

// ============================================================================
// FUNÇÕES DE CADASTROS PENDENTES - CORRIGIDAS
// ============================================================================

async function aprovarCadastro(cadastro) {
  try {
    const response = await fetch(`/api/cadastros/${cadastro.id}/aprovar`, {
      method: 'POST',
      credentials: 'include'
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Atualizar arrays locais
      const index = cadastros.findIndex(c => c.id === cadastro.id);
      if (index !== -1) {
        const novoUsuario = { ...cadastro, tipo: 'aluno', status: 'aprovado' };
        cadastros.splice(index, 1);
        users.push(novoUsuario);
      }
      
      exibirConteudo();
      mostrarMensagemSucesso(`Usuário ${cadastro.usuario} aprovado como aluno!`);
    } else {
      alert('Erro ao aprovar cadastro: ' + data.message);
    }
  } catch (error) {
    console.error('Erro ao aprovar cadastro:', error);
    alert('Erro de conexão ao aprovar cadastro');
  }
}

async function rejeitarCadastro(cadastro) {
  if (confirm(`Deseja rejeitar o cadastro de ${cadastro.usuario}?`)) {
    try {
      const response = await fetch(`/api/cadastros/${cadastro.id}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      
      const data = await response.json();
      
      if (data.success) {
        const index = cadastros.findIndex(c => c.id === cadastro.id);
        if (index !== -1) {
          cadastros.splice(index, 1);
        }
        
        exibirConteudo();
        mostrarMensagemSucesso(`Cadastro de ${cadastro.usuario} rejeitado.`);
      } else {
        alert('Erro ao rejeitar cadastro: ' + data.message);
      }
    } catch (error) {
      console.error('Erro ao rejeitar cadastro:', error);
      alert('Erro de conexão ao rejeitar cadastro');
    }
  }
}

// ============================================================================
// FUNÇÕES DE GERENCIAMENTO DE QUIZ - CORRIGIDAS
// ============================================================================

async function arquivarQuiz(quiz) {
  if (confirm(`Deseja arquivar o quiz "${quiz.nome || quiz.titulo}"?`)) {
    try {
      const response = await fetch(`/api/quizzes/${quiz.id}/arquivar`, {
        method: 'PUT',
        credentials: 'include'
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Atualizar arrays locais
        const index = quizzes.findIndex(q => q.id === quiz.id);
        if (index !== -1) {
          const quizArquivado = { ...quiz, arquivado: true };
          quizzes.splice(index, 1);
          quizzesArquivados.push(quizArquivado);
        }
        
        exibirConteudo();
        mostrarMensagemSucesso(`Quiz "${quiz.nome || quiz.titulo}" arquivado com sucesso!`);
      } else {
        alert('Erro ao arquivar quiz: ' + data.message);
      }
    } catch (error) {
      console.error('Erro ao arquivar quiz:', error);
      alert('Erro de conexão ao arquivar quiz');
    }
  }
}

async function desarquivarQuiz(quiz) {
  if (confirm(`Deseja desarquivar o quiz "${quiz.nome || quiz.titulo}"?`)) {
    try {
      const response = await fetch(`/api/quizzes/${quiz.id}/desarquivar`, {
        method: 'PUT',
        credentials: 'include'
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Atualizar arrays locais
        const index = quizzesArquivados.findIndex(q => q.id === quiz.id);
        if (index !== -1) {
          const quizDesarquivado = { ...quiz };
          delete quizDesarquivado.arquivado;
          quizzesArquivados.splice(index, 1);
          quizzes.push(quizDesarquivado);
        }
        
        exibirConteudo();
        mostrarMensagemSucesso(`Quiz "${quiz.nome || quiz.titulo}" desarquivado com sucesso!`);
      } else {
        alert('Erro ao desarquivar quiz: ' + data.message);
      }
    } catch (error) {
      console.error('Erro ao desarquivar quiz:', error);
      alert('Erro de conexão ao desarquivar quiz');
    }
  }
}

async function excluirQuiz(quiz) {
  if (confirm(`Deseja realmente excluir o quiz "${quiz.nome || quiz.titulo}"? Ele será movido para a lixeira.`)) {
    try {
      const response = await fetch(`/api/quizzes/${quiz.id}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Atualizar arrays locais
        let index = quizzes.findIndex(q => q.id === quiz.id);
        let origem = 'ativo';
        
        if (index === -1) {
          index = quizzesArquivados.findIndex(q => q.id === quiz.id);
          origem = 'arquivado';
        }
        
        if (index !== -1) {
          const quizExcluido = { ...quiz, excluido: true };
          
          if (origem === 'ativo') {
            quizzes.splice(index, 1);
          } else {
            quizzesArquivados.splice(index, 1);
          }
          
          quizzesExcluidos.push(quizExcluido);
        }
        
        exibirConteudo();
        mostrarMensagemSucesso(`Quiz "${quiz.nome || quiz.titulo}" excluído com sucesso!`);
      } else {
        alert('Erro ao excluir quiz: ' + data.message);
      }
    } catch (error) {
      console.error('Erro ao excluir quiz:', error);
      alert('Erro de conexão ao excluir quiz');
    }
  }
}

async function restaurarQuiz(quiz) {
  if (confirm(`Deseja restaurar o quiz "${quiz.nome || quiz.titulo}" para os quizzes ativos?`)) {
    try {
      const response = await fetch(`/alterar-status-quiz`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          id: quiz.id,
          status: 'ativo'
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        const index = quizzesExcluidos.findIndex(q => q.id === quiz.id);
        if (index !== -1) {
          const quizRestaurado = { ...quiz, status: 'ativo' };
          delete quizRestaurado.excluido;
          quizzesExcluidos.splice(index, 1);
          quizzes.push(quizRestaurado);
        }
        
        exibirConteudo();
        mostrarMensagemSucesso(`Quiz "${quiz.nome || quiz.titulo}" restaurado com sucesso!`);
      } else {
        alert('Erro ao restaurar quiz: ' + data.message);
      }
    } catch (error) {
      console.error('Erro ao restaurar quiz:', error);
      alert('Erro de conexão ao restaurar quiz');
    }
  }
}

async function excluirQuizPermanentemente(quiz) {
  if (confirm(`⚠️ ATENÇÃO: Deseja excluir PERMANENTEMENTE o quiz "${quiz.nome || quiz.titulo}"? Esta ação NÃO PODE ser desfeita!`)) {
    // Para exclusão permanente, implementar no backend se necessário
    // Por enquanto, apenas remove do array local
    const index = quizzesExcluidos.findIndex(q => q.id === quiz.id);
    if (index !== -1) {
      quizzesExcluidos.splice(index, 1);
      exibirConteudo();
      mostrarMensagemSucesso(`Quiz "${quiz.nome || quiz.titulo}" excluído permanentemente!`);
    }
  }
}

// ============================================================================
// FUNÇÕES DE GERENCIAMENTO DE USUÁRIOS - CORRIGIDAS
// ============================================================================

function editUser(user) {
  if (!validarPermissao('editar_usuarios')) {
    alert('Você não tem permissão para editar usuários.');
    return;
  }
  
  currentEditingUser = user;
  const nomeCompleto = `${user.nome || ''} ${user.sobrenome || ''}`.trim();
  document.getElementById('editUserName').value = nomeCompleto;
  document.getElementById('editUserEmail').value = user.email || '';
  document.getElementById('editUserPhone').value = user.telefone || user.celular || '';
  document.getElementById('editUserType').value = user.tipo || 'aluno';
  openModal('editUserModal');
}

async function saveUserEdit() {
  if (!currentEditingUser) return;
  
  const fullName = document.getElementById('editUserName').value.trim().split(' ');
  const nome = fullName[0];
  const sobrenome = fullName.slice(1).join(' ');
  const email = document.getElementById('editUserEmail').value.trim();
  const telefone = document.getElementById('editUserPhone').value.trim();
  const tipo = document.getElementById('editUserType').value;
  
  if (!nome || !email) {
    alert('Nome e email são obrigatórios!');
    return;
  }
  
  if (currentEditingUser.tipo !== tipo && !validarPermissao('promover_rebaixar')) {
    alert('Apenas administradores podem alterar o tipo de usuário.');
    return;
  }
  
  try {
    // Se mudou o tipo, usar API de alterar role
    if (currentEditingUser.tipo !== tipo) {
      const roleResponse = await fetch('/alterar-role', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          usuario: currentEditingUser.usuario,
          role: tipo
        })
      });
      
      const roleData = await roleResponse.json();
      if (!roleData.success) {
        alert('Erro ao alterar tipo de usuário: ' + roleData.message);
        return;
      }
    }
    
    // Atualizar outros dados
    const response = await fetch(`/api/usuarios/${currentEditingUser.usuario}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        nome,
        sobrenome,
        email,
        telefone,
        tipo
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Atualizar dados locais
      const userIndex = users.findIndex(u => u.usuario === currentEditingUser.usuario || u.id === currentEditingUser.id);
      if (userIndex !== -1) {
        users[userIndex].nome = nome;
        users[userIndex].sobrenome = sobrenome;
        users[userIndex].email = email;
        users[userIndex].telefone = telefone;
        users[userIndex].tipo = tipo;
      }
      
      closeModal('editUserModal');
      exibirConteudo();
      mostrarMensagemSucesso(`Usuário ${currentEditingUser.usuario} editado com sucesso!`);
    } else {
      alert('Erro ao editar usuário: ' + data.message);
    }
    
  } catch (error) {
    console.error('Erro ao salvar usuário:', error);
    alert('Erro de conexão ao salvar usuário');
  }
}

function changePassword(user) {
  if (!validarPermissao('alterar_senhas')) {
    alert('Você não tem permissão para alterar senhas.');
    return;
  }
  
  currentEditingUser = user;
  document.getElementById('newPassword').value = '';
  document.getElementById('confirmPassword').value = '';
  openModal('changePasswordModal');
}

async function changeUserPassword() {
  if (!currentEditingUser) return;
  
  const newPassword = document.getElementById('newPassword').value.trim();
  const confirmPassword = document.getElementById('confirmPassword').value.trim();
  
  if (!newPassword || !confirmPassword) {
    alert('Digite e confirme a nova senha!');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    alert('As senhas não coincidem!');
    return;
  }
  
  if (newPassword.length < 6) {
    alert('A senha deve ter pelo menos 6 caracteres!');
    return;
  }
  
  try {
    const response = await fetch('/alterar-senha', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        usuario: currentEditingUser.usuario,
        novaSenha: newPassword
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      closeModal('changePasswordModal');
      mostrarMensagemSucesso(`Senha do usuário ${currentEditingUser.usuario} alterada com sucesso!`);
    } else {
      alert('Erro ao alterar senha: ' + data.message);
    }
  } catch (error) {
    console.error('Erro ao alterar senha:', error);
    alert('Erro de conexão ao alterar senha');
  }
}

async function deleteUser(user) {
  if (!validarPermissao('excluir_usuarios')) {
    alert('Apenas administradores podem excluir usuários.');
    return;
  }
  
  if (user.usuario === usuarioLogado.usuario) {
    alert('Você não pode excluir seu próprio usuário!');
    return;
  }
  
  if (confirm(`Deseja realmente excluir o usuário ${user.usuario}? Esta ação não pode ser desfeita.`)) {
    try {
      const response = await fetch('/excluir-usuario', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          usuario: user.usuario
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        const userIndex = users.findIndex(u => u.usuario === user.usuario);
        if (userIndex !== -1) {
          users.splice(userIndex, 1);
        }
        
        exibirConteudo();
        mostrarMensagemSucesso(`Usuário ${user.usuario} excluído com sucesso!`);
      } else {
        alert('Erro ao excluir usuário: ' + data.message);
      }
    } catch (error) {
      console.error('Erro ao excluir usuário:', error);
      alert('Erro de conexão ao excluir usuário');
    }
  }
}

async function promoteUser(user) {
  if (!validarPermissao('promover_rebaixar')) {
    alert('Apenas administradores podem promover usuários.');
    return;
  }
  
  const newType = user.tipo === 'aluno' ? 'moderador' : 'administrador';
  if (confirm(`Deseja promover ${user.usuario} para ${newType}?`)) {
    try {
      const response = await fetch('/alterar-role', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          usuario: user.usuario,
          role: newType
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        const userIndex = users.findIndex(u => u.usuario === user.usuario);
        if (userIndex !== -1) {
          users[userIndex].tipo = newType;
        }
        
        exibirConteudo();
        mostrarMensagemSucesso(`${user.usuario} promovido para ${newType}!`);
      } else {
        alert('Erro ao promover usuário: ' + data.message);
      }
    } catch (error) {
      console.error('Erro ao promover usuário:', error);
      alert('Erro de conexão ao promover usuário');
    }
  }
}

async function demoteUser(user) {
  if (!validarPermissao('promover_rebaixar')) {
    alert('Apenas administradores podem rebaixar usuários.');
    return;
  }
  
  const newType = user.tipo === 'administrador' ? 'moderador' : 'aluno';
  if (confirm(`Deseja rebaixar ${user.usuario} para ${newType}?`)) {
    try {
      const response = await fetch('/alterar-role', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          usuario: user.usuario,
          role: newType
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        const userIndex = users.findIndex(u => u.usuario === user.usuario);
        if (userIndex !== -1) {
          users[userIndex].tipo = newType;
        }
        
        exibirConteudo();
        mostrarMensagemSucesso(`${user.usuario} rebaixado para ${newType}!`);
      } else {
        alert('Erro ao rebaixar usuário: ' + data.message);
      }
    } catch (error) {
      console.error('Erro ao rebaixar usuário:', error);
      alert('Erro de conexão ao rebaixar usuário');
    }
  }
}

// ============================================================================
// FUNÇÕES DE PDF - CORRIGIDAS
// ============================================================================

function uploadPDF() {
  if (!validarPermissao('upload_pdf')) {
    alert('Você não tem permissão para fazer upload de PDFs.');
    return;
  }
  
  const fileInput = document.getElementById('fileInput');
  fileInput.click();
}

async function handleFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (file.type !== 'application/pdf') {
    alert('Apenas arquivos PDF são permitidos!');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const response = await fetch('/upload-pdf', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
          nome: file.name,
          base64: e.target.result
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Recarregar PDFs
        await carregarDadosReais();
        
        if (currentTab === 'pdfs') {
          exibirConteudo();
        }
        
        mostrarMensagemSucesso(`PDF "${file.name}" enviado com sucesso! (Bloqueado para download)`);
      } else {
        alert('Erro ao enviar PDF: ' + data.message);
      }
    } catch (error) {
      console.error('Erro ao enviar PDF:', error);
      alert('Erro de conexão ao enviar PDF');
    }
  };
  
  reader.readAsDataURL(file);
}

async function togglePdfLock(pdf) {
  if (!validarPermissao('gerenciar_pdfs')) {
    alert('Apenas administradores podem alterar o status dos PDFs.');
    return;
  }
  
  try {
    const response = await fetch(`/api/pdfs/${pdf.id}/toggle-lock`, {
      method: 'PUT',
      credentials: 'include'
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Atualizar array local
      const pdfIndex = pdfs.findIndex(p => p.id === pdf.id);
      if (pdfIndex !== -1) {
        pdfs[pdfIndex].bloqueado = !pdfs[pdfIndex].bloqueado;
      }
      
      exibirConteudo();
      mostrarMensagemSucesso(data.message);
    } else {
      alert('Erro: ' + data.message);
    }
  } catch (error) {
    console.error('Erro ao alterar PDF:', error);
    alert('Erro de conexão');
  }
}

function downloadPdf(pdf) {
  if (pdf.bloqueado) {
    alert('Este PDF está bloqueado para download. Entre em contato com um administrador.');
    return;
  }
  
  const link = document.createElement('a');
  link.href = pdf.base64 || pdf.dados;
  link.download = pdf.nome;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function viewPdf(pdf) {
  const modal = document.getElementById('pdfViewerModal');
  const title = document.getElementById('pdfViewerTitle');
  const frame = document.getElementById('pdfFrame');
  
  title.textContent = pdf.nome;
  frame.src = pdf.base64 || pdf.dados;
  modal.style.display = 'block';
}

function closePdfViewer() {
  const modal = document.getElementById('pdfViewerModal');
  const frame = document.getElementById('pdfFrame');
  modal.style.display = 'none';
  frame.src = '';
}

async function deletePdf(pdf) {
  if (!validarPermissao('gerenciar_pdfs')) {
    alert('Apenas administradores podem excluir PDFs.');
    return;
  }
  
  if (confirm(`Deseja realmente excluir o PDF "${pdf.nome}"? Ele será movido para a lixeira.`)) {
    try {
      const response = await fetch(`/api/pdfs/${pdf.id}`, {
        method: 'DELETE',
        credentials: 'include'
      });
      
      const data = await response.json();
      
      if (data.success) {
        const pdfIndex = pdfs.findIndex(p => p.id === pdf.id);
        if (pdfIndex !== -1) {
          const pdfExcluido = { ...pdf, excluido: true, dataExclusao: new Date().toISOString() };
          
          pdfs.splice(pdfIndex, 1);
          pdfsExcluidos.push(pdfExcluido);
        }
        
        exibirConteudo();
        mostrarMensagemSucesso(`PDF "${pdf.nome}" excluído com sucesso!`);
      } else {
        alert('Erro ao excluir PDF: ' + data.message);
      }
    } catch (error) {
      console.error('Erro ao excluir PDF:', error);
      alert('Erro de conexão ao excluir PDF');
    }
  }
}

function restaurarPdf(pdf) {
  if (confirm(`Deseja restaurar o PDF "${pdf.nome}" para os PDFs ativos?`)) {
    const index = pdfsExcluidos.findIndex(p => p.id === pdf.id);
    if (index !== -1) {
      const pdfRestaurado = { ...pdf };
      delete pdfRestaurado.excluido;
      delete pdfRestaurado.dataExclusao;
      
      pdfsExcluidos.splice(index, 1);
      pdfs.push(pdfRestaurado);
      
      exibirConteudo();
      mostrarMensagemSucesso(`PDF "${pdf.nome}" restaurado com sucesso!`);
    }
  }
}

function excluirPdfPermanentemente(pdf) {
  if (confirm(`⚠️ ATENÇÃO: Deseja excluir PERMANENTEMENTE o PDF "${pdf.nome}"? Esta ação NÃO PODE ser desfeita!`)) {
    const index = pdfsExcluidos.findIndex(p => p.id === pdf.id);
    if (index !== -1) {
      pdfsExcluidos.splice(index, 1);
      exibirConteudo();
      mostrarMensagemSucesso(`PDF "${pdf.nome}" excluído permanentemente!`);
    }
  }
}

// ============================================================================
// FUNÇÕES DE MODAL E INTERFACE
// ============================================================================

function openModal(modalId) {
  document.getElementById(modalId).style.display = 'block';
  
  const modal = document.getElementById(modalId);
  const closeBtn = modal.querySelector('.close');
  closeBtn.onclick = () => closeModal(modalId);
  
  window.onclick = function(event) {
    if (event.target === modal) {
      closeModal(modalId);
    }
  };
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
  currentEditingUser = null;
  pendingProfileData = null;
}

// ============================================================================
// CRIAÇÃO DE CARDS ESPECÍFICOS
// ============================================================================

function criarCardPdf(pdf) {
  const card = document.createElement('div');
  card.className = 'pdf-card';

  const icon = document.createElement('div');
  icon.className = 'pdf-icon';
  icon.textContent = '📄';
  icon.onclick = () => viewPdf(pdf);
  card.appendChild(icon);

  const name = document.createElement('div');
  name.className = 'pdf-card-name';
  name.textContent = pdf.nome;
  card.appendChild(name);

  const status = document.createElement('div');
  status.className = `pdf-status ${pdf.bloqueado ? 'pdf-locked' : 'pdf-unlocked'}`;
  status.innerHTML = pdf.bloqueado ? '🔒 Download Bloqueado' : '🔓 Download Liberado';
  card.appendChild(status);

  const info = document.createElement('div');
  info.style.fontSize = '0.8rem';
  info.style.color = '#666';
  info.style.textAlign = 'center';
  info.style.marginTop = '10px';
  info.innerHTML = `
    <div>Enviado por: ${pdf.uploadedBy}</div>
    <div>${new Date(pdf.uploadedAt || pdf.dataUpload).toLocaleDateString('pt-BR')}</div>
  `;
  card.appendChild(info);

  // Menu de opções
  if (validarPermissao('gerenciar_pdfs') || currentTab === 'excluidos') {
    const gearMenu = document.createElement('div');
    gearMenu.className = 'gear-menu';
    
    const menuOptions = document.createElement('div');
    menuOptions.className = 'menu-options';
    
    if (currentTab === 'excluidos') {
      const btnRestaurar = document.createElement('button');
      btnRestaurar.textContent = '🔄 Restaurar';
      btnRestaurar.onclick = (e) => {
        e.stopPropagation();
        restaurarPdf(pdf);
      };
      
      const btnExcluirPermanente = document.createElement('button');
      btnExcluirPermanente.className = 'danger';
      btnExcluirPermanente.textContent = '💀 Excluir Permanentemente';
      btnExcluirPermanente.onclick = (e) => {
        e.stopPropagation();
        excluirPdfPermanentemente(pdf);
      };
      
      menuOptions.appendChild(btnRestaurar);
      menuOptions.appendChild(btnExcluirPermanente);
    } else {
      const btnToggleLock = document.createElement('button');
      btnToggleLock.textContent = pdf.bloqueado ? '🔓 Liberar Download' : '🔒 Bloquear Download';
      btnToggleLock.onclick = (e) => {
        e.stopPropagation();
        togglePdfLock(pdf);
      };
      
      const btnExcluir = document.createElement('button');
      btnExcluir.className = 'danger';
      btnExcluir.textContent = '🗑️ Excluir';
      btnExcluir.onclick = (e) => {
        e.stopPropagation();
        deletePdf(pdf);
      };
      
      menuOptions.appendChild(btnToggleLock);
      menuOptions.appendChild(btnExcluir);
    }
    
    gearMenu.onclick = (e) => {
      e.stopPropagation();
      const isVisible = menuOptions.style.display === 'block';
      document.querySelectorAll('.menu-options').forEach(m => m.style.display = 'none');
      menuOptions.style.display = isVisible ? 'none' : 'block';
    };
    
    card.appendChild(gearMenu);
    card.appendChild(menuOptions);
  }

  const actions = document.createElement('div');
  actions.className = 'user-actions';
  actions.style.marginTop = '15px';

  const btnView = document.createElement('button');
  btnView.textContent = '👀 Visualizar';
  btnView.onclick = () => viewPdf(pdf);
  
  const btnDownload = document.createElement('button');
  btnDownload.textContent = '📥 Download';
  btnDownload.onclick = () => downloadPdf(pdf);
  
  if (pdf.bloqueado) {
    btnDownload.disabled = true;
    btnDownload.title = 'Download bloqueado pelo administrador';
    btnDownload.style.background = '#666';
    btnDownload.style.color = '#999';
  }

  actions.appendChild(btnView);
  actions.appendChild(btnDownload);
  card.appendChild(actions);

  return card;
}

function criarCardQuiz(quiz) {
  const card = document.createElement('div');
  card.className = 'quiz-card';

  if (quiz.imagem || quiz.imagemBase64) {
    const img = document.createElement('img');
    img.src = quiz.imagem || quiz.imagemBase64;
    img.alt = quiz.nome || quiz.titulo;
    img.className = 'quiz-image';
    card.appendChild(img);
  }

  const title = document.createElement('div');
  title.className = 'quiz-title';
  title.textContent = quiz.nome || quiz.titulo;
  card.appendChild(title);

  // Menu de opções
  if (validarPermissao('editar_quiz') || currentTab === 'excluidos') {
    const gearMenu = document.createElement('div');
    gearMenu.className = 'gear-menu';
    
    const menuOptions = document.createElement('div');
    menuOptions.className = 'menu-options';
    
    if (currentTab === 'excluidos') {
      const btnRestaurar = document.createElement('button');
      btnRestaurar.textContent = '🔄 Restaurar';
      btnRestaurar.onclick = (e) => {
        e.stopPropagation();
        restaurarQuiz(quiz);
      };
      
      const btnExcluirPermanente = document.createElement('button');
      btnExcluirPermanente.className = 'danger';
      btnExcluirPermanente.textContent = '💀 Excluir Permanentemente';
      btnExcluirPermanente.onclick = (e) => {
        e.stopPropagation();
        excluirQuizPermanentemente(quiz);
      };
      
      menuOptions.appendChild(btnRestaurar);
      menuOptions.appendChild(btnExcluirPermanente);
    } else {
      const btnEditar = document.createElement('button');
      btnEditar.textContent = '✏️ Editar';
      btnEditar.onclick = (e) => {
        e.stopPropagation();
        localStorage.setItem('quizParaEditar', JSON.stringify(quiz));
        window.location.href = '/painel.html';
      };
      
      const btnArquivar = document.createElement('button');
      btnArquivar.textContent = currentTab === 'ativos' ? '📁 Arquivar' : '📤 Desarquivar';
      btnArquivar.onclick = async (e) => {
        e.stopPropagation();
        if (currentTab === 'ativos') {
          await arquivarQuiz(quiz);
        } else {
          await desarquivarQuiz(quiz);
        }
      };
      
      const btnExcluir = document.createElement('button');
      btnExcluir.className = 'danger';
      btnExcluir.textContent = '🗑️ Excluir';
      btnExcluir.onclick = (e) => {
        e.stopPropagation();
        excluirQuiz(quiz);
      };
      btnExcluir.disabled = !validarPermissao('excluir_quiz');
      
      menuOptions.appendChild(btnEditar);
      menuOptions.appendChild(btnArquivar);
      menuOptions.appendChild(btnExcluir);
    }
    
    gearMenu.onclick = (e) => {
      e.stopPropagation();
      const isVisible = menuOptions.style.display === 'block';
      document.querySelectorAll('.menu-options').forEach(m => m.style.display = 'none');
      menuOptions.style.display = isVisible ? 'none' : 'block';
    };
    
    card.appendChild(gearMenu);
    card.appendChild(menuOptions);
  }

  // Clique para jogar quiz (apenas em ativos)
  if (currentTab === 'ativos') {
    card.onclick = (e) => {
      if (e.target.closest('.gear-menu') || e.target.closest('.menu-options')) {
        return;
      }
      
      if (!quiz.perguntas || quiz.perguntas.length === 0) {
        alert('Este quiz ainda não possui perguntas. Edite-o para adicionar perguntas.');
        return;
      }
      
      const quizParaJogar = {
        id: quiz.id,
        nome: quiz.nome || quiz.titulo,
        imagem: quiz.imagem || quiz.imagemBase64,
        perguntas: quiz.perguntas,
        configuracoes: quiz.configuracoes || {}
      };
      
      localStorage.setItem('quizAtual', JSON.stringify(quizParaJogar));
      window.location.href = '/quiz.html';
    };
  }

  return card;
}

// ============================================================================
// EXIBIÇÃO DE CALENDÁRIO ACADÊMICO - MANTIDA COMPLETA
// ============================================================================

function exibirCalendario() {
  const container = document.createElement('div');
  container.className = 'calendar-container';
  
  const title = document.createElement('h2');
  title.style.textAlign = 'center';
  title.style.color = '#0af';
  title.style.textShadow = '0 0 10px rgba(0,170,255,0.5)';
  title.style.marginBottom = '30px';
  title.textContent = '📅 Calendário Acadêmico 2025-2029';
  container.appendChild(title);

  const legend = document.createElement('div');
  legend.className = 'status-legend';
  legend.innerHTML = `
    <div class="legend-item legend-current">
      <span>🟢</span>
      <span>Período Atual</span>
    </div>
    <div class="legend-item legend-future">
      <span>⚪</span>
      <span>Período Futuro</span>
    </div>
    <div class="legend-item legend-past">
      <span>🔴</span>
      <span>Período Passado</span>
    </div>
  `;
  container.appendChild(legend);

  const table = document.createElement('table');
  table.className = 'calendar-table';
  
  const thead = document.createElement('thead');
  thead.innerHTML = `
    <tr>
      <th>Período</th>
      <th>Módulo (UTA)</th>
      <th>Fase</th>
      <th>Período estimado</th>
      <th>Observações</th>
    </tr>
  `;
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  const periodoAtualIndex = determinarPeriodoAtual();
  
  calendarioAcademico.forEach((item, index) => {
    const row = document.createElement('tr');
    
    let rowClass = '';
    if (index < periodoAtualIndex) {
      rowClass = 'past-period';
    } else if (index === periodoAtualIndex) {
      rowClass = 'current-period';
    } else {
      rowClass = 'future-period';
    }
    
    if (item.periodo && item.periodo !== '') {
      rowClass += ' period-header';
    }
    
    if (index === calendarioAcademico.length - 1) {
      rowClass = 'completion-info';
    }
    
    row.className = rowClass;
    
    row.innerHTML = `
      <td>${item.periodo}</td>
      <td>${item.modulo}</td>
      <td>${item.fase}</td>
      <td>${item.dataEstimada}</td>
      <td>${item.observacoes}</td>
    `;
    
    tbody.appendChild(row);
  });
  
  table.appendChild(tbody);
  container.appendChild(table);

  const info = document.createElement('div');
  info.style.marginTop = '30px';
  info.style.padding = '20px';
  info.style.background = 'rgba(0,170,255,0.1)';
  info.style.borderRadius = '10px';
  info.style.border = '1px solid rgba(0,170,255,0.3)';
  info.style.textAlign = 'center';
  info.innerHTML = `
    <h3 style="color: #0af; margin-bottom: 15px;">ℹ️ Informações Importantes</h3>
    <p style="color: #0af; margin: 10px 0;">
      <strong>• Formatura prevista:</strong> 2029
    </p>
    <p style="color: #0af; margin: 10px 0;">
      <strong>• Duração total do curso:</strong> 4 anos (8 períodos)
    </p>
    <p style="color: #0af; margin: 10px 0;">
      <strong>• Cada período:</strong> 3 módulos (A, B, C) com 2 fases cada
    </p>
  `;
  container.appendChild(info);

  quizzesContainer.appendChild(container);
}

// ============================================================================
// EXIBIÇÃO DE PERFIL - MANTIDA COMPLETA
// ============================================================================

function exibirPerfil() {
  const container = document.createElement('div');
  container.className = 'perfil-form';
  
  const form = document.createElement('form');
  form.onsubmit = (e) => {
    e.preventDefault();
    saveProfile();
  };
  
  form.innerHTML = `
    <h2>👤 Meu Perfil</h2>
    
    <div class="photo-upload">
      <div class="current-photo" onclick="changeProfilePhoto()">
        ${usuarioLogado.fotoBase64 ? 
          `<img src="${usuarioLogado.fotoBase64}" alt="Foto do perfil">` : 
          usuarioLogado.nome.charAt(0).toUpperCase()
        }
      </div>
      <p style="color: #666; font-size: 0.9rem;">Clique na foto para alterar</p>
    </div>

    <div class="form-group">
      <label for="profileNome">Nome:</label>
      <input type="text" id="profileNome" value="${usuarioLogado.nome}" required>
    </div>

    <div class="form-group">
      <label for="profileSobrenome">Sobrenome:</label>
      <input type="text" id="profileSobrenome" value="${usuarioLogado.sobrenome || ''}">
    </div>

    <div class="form-group">
      <label for="profileUsuario">Usuário:</label>
      <input type="text" id="profileUsuario" value="${usuarioLogado.usuario}" disabled style="background: #333; color: #666;">
    </div>

    <div class="form-group">
      <label for="profileEmail">Email:</label>
      <input type="email" id="profileEmail" value="${usuarioLogado.email}" required>
    </div>

    <div class="form-group">
      <label for="profileTelefone">Telefone:</label>
      <input type="text" id="profileTelefone" value="${usuarioLogado.telefone || ''}">
    </div>

    <div class="form-group">
      <label for="profileTipo">Tipo de Usuário:</label>
      <input type="text" id="profileTipo" value="${usuarioLogado.tipo}" disabled style="background: #333; color: #666;">
    </div>

    <button type="submit" class="save-btn">💾 Salvar Alterações</button>
  `;
  
  container.appendChild(form);
  quizzesContainer.appendChild(container);
}

function changeProfilePhoto() {
  const photoInput = document.getElementById('profilePhotoInput');
  photoInput.click();
}

function handleProfilePhotoUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (!file.type.startsWith('image/')) {
    alert('Apenas arquivos de imagem são permitidos!');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    const currentPhoto = document.querySelector('.current-photo');
    currentPhoto.innerHTML = `<img src="${e.target.result}" alt="Foto do perfil">`;
    window.tempProfilePhoto = e.target.result;
  };
  
  reader.readAsDataURL(file);
}

async function saveProfile() {
  const nome = document.getElementById('profileNome').value.trim();
  const sobrenome = document.getElementById('profileSobrenome').value.trim();
  const email = document.getElementById('profileEmail').value.trim();
  const telefone = document.getElementById('profileTelefone').value.trim();
  
  if (!nome || !email) {
    alert('Nome e email são obrigatórios!');
    return;
  }
  
  pendingProfileData = {
    nome,
    sobrenome,
    email,
    telefone,
    fotoBase64: window.tempProfilePhoto || usuarioLogado.fotoBase64
  };
  
  openModal('profilePasswordModal');
}

async function confirmProfileSave() {
  const currentPassword = document.getElementById('currentPassword').value;
  
  if (!currentPassword) {
    alert('Digite sua senha atual para confirmar!');
    return;
  }
  
  try {
    const response = await fetch('/api/perfil', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({
        ...pendingProfileData,
        senhaAtual: currentPassword
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Atualizar dados localmente
      usuarioLogado = {
        ...usuarioLogado,
        ...pendingProfileData
      };
      
      closeModal('profilePasswordModal');
      exibirConteudo();
      mostrarMensagemSucesso('Perfil atualizado com sucesso!');
      
      delete window.tempProfilePhoto;
    } else {
      alert('Erro ao salvar perfil: ' + data.message);
    }
  } catch (error) {
    console.error('Erro ao salvar perfil:', error);
    alert('Erro de conexão ao salvar perfil');
  }
}

// ============================================================================
// EXIBIÇÃO DE CONTEÚDO PRINCIPAL
// ============================================================================

function exibirConteudo() {
  quizzesContainer.innerHTML = '';

  switch (currentTab) {
    case 'ativos':
      exibirQuizzes(quizzes, 'Quizzes Ativos');
      break;
    case 'arquivados':
      if (validarPermissao('ver_arquivados')) {
        exibirQuizzes(quizzesArquivados, 'Quizzes Arquivados');
      } else {
        alert('Você não tem permissão para acessar esta área.');
        document.querySelector('[data-tab="ativos"]').click();
      }
      break;
    case 'usuarios':
      if (validarPermissao('gerenciar_usuarios')) {
        exibirUsuarios();
      } else {
        alert('Você não tem permissão para acessar esta área.');
        document.querySelector('[data-tab="ativos"]').click();
      }
      break;
    case 'cadastros':
      if (validarPermissao('gerenciar_usuarios')) {
        exibirCadastrosPendentes();
      } else {
        alert('Você não tem permissão para acessar esta área.');
        document.querySelector('[data-tab="ativos"]').click();
      }
      break;
    case 'excluidos':
      if (validarPermissao('ver_excluidos')) {
        exibirExcluidos();
      } else {
        alert('Você não tem permissão para acessar esta área.');
        document.querySelector('[data-tab="ativos"]').click();
      }
      break;
    case 'pdfs':
      exibirPDFs();
      break;
    case 'calendario':
      exibirCalendario();
      break;
    case 'perfil':
      exibirPerfil();
      break;
    default:
      quizzesContainer.innerHTML = '<p class="empty-message">Nenhum conteúdo disponível.</p>';
      break;
  }
}

function exibirQuizzes(lista, titulo = 'Quizzes') {
  if (!lista.length) {
    quizzesContainer.innerHTML = `<p class="empty-message">Nenhum quiz nesta seção.</p>`;
    return;
  }

  const grid = document.createElement('div');
  grid.className = 'items-grid';

  lista.forEach(quiz => {
    const card = criarCardQuiz(quiz);
    grid.appendChild(card);
  });

  quizzesContainer.appendChild(grid);
}

function exibirExcluidos() {
  const container = document.createElement('div');
  
  if (quizzesExcluidos.length > 0) {
    const quizSection = document.createElement('div');
    quizSection.className = 'section-container';
    
    const quizTitle = document.createElement('div');
    quizTitle.className = 'section-title';
    quizTitle.innerHTML = '<span>🎯 Quizzes Excluídos</span>';
    quizSection.appendChild(quizTitle);
    
    const quizGrid = document.createElement('div');
    quizGrid.className = 'items-grid';
    
    quizzesExcluidos.forEach(quiz => {
      const card = criarCardQuiz(quiz);
      quizGrid.appendChild(card);
    });
    
    quizSection.appendChild(quizGrid);
    container.appendChild(quizSection);
  }
  
  if (pdfsExcluidos.length > 0) {
    const pdfSection = document.createElement('div');
    pdfSection.className = 'section-container';
    
    const pdfTitle = document.createElement('div');
    pdfTitle.className = 'section-title';
    pdfTitle.innerHTML = '<span>📄 PDFs Excluídos</span>';
    pdfSection.appendChild(pdfTitle);
    
    const pdfGrid = document.createElement('div');
    pdfGrid.className = 'items-grid';
    
    pdfsExcluidos.forEach(pdf => {
      const card = criarCardPdf(pdf);
      pdfGrid.appendChild(card);
    });
    
    pdfSection.appendChild(pdfGrid);
    container.appendChild(pdfSection);
  }
  
  if (quizzesExcluidos.length === 0 && pdfsExcluidos.length === 0) {
    container.innerHTML = '<p class="empty-message">🗑️ Nenhum item na lixeira.</p>';
  }
  
  quizzesContainer.appendChild(container);
}

function exibirUsuarios() {
  if (users.length === 0) {
    quizzesContainer.innerHTML = '<p class="empty-message">Nenhum usuário cadastrado.</p>';
    return;
  }

  const title = document.createElement('div');
  title.className = 'section-title';
  title.innerHTML = `<span>👥 Gerenciar Usuários</span>`;
  quizzesContainer.appendChild(title);

  const usersGrid = document.createElement('div');
  usersGrid.className = 'items-grid';

  users.forEach(user => {
    const card = document.createElement('div');
    card.className = 'user-card';

    const badge = document.createElement('div');
    badge.className = `user-badge badge-${user.tipo}`;
    badge.textContent = user.tipo;
    card.appendChild(badge);

    if (validarPermissao('gerenciar_usuarios') && user.usuario !== usuarioLogado.usuario) {
      const gearMenu = document.createElement('div');
      gearMenu.className = 'gear-menu';
      gearMenu.style.top = '50px';
      
      const menuOptions = document.createElement('div');
      menuOptions.className = 'menu-options';
      
      if (validarPermissao('editar_usuarios')) {
        const btnEditar = document.createElement('button');
        btnEditar.textContent = '✏️ Editar';
        btnEditar.onclick = (e) => {
          e.stopPropagation();
          editUser(user);
        };
        menuOptions.appendChild(btnEditar);
      }
      
      if (validarPermissao('alterar_senhas')) {
        const btnSenha = document.createElement('button');
        btnSenha.textContent = '🔑 Alterar Senha';
        btnSenha.onclick = (e) => {
          e.stopPropagation();
          changePassword(user);
        };
        menuOptions.appendChild(btnSenha);
      }
      
      if (validarPermissao('promover_rebaixar') && user.tipo !== 'administrador') {
        if (user.tipo === 'aluno') {
          const btnPromover = document.createElement('button');
          btnPromover.textContent = '⬆️ Promover a Moderador';
          btnPromover.onclick = (e) => {
            e.stopPropagation();
            promoteUser(user);
          };
          menuOptions.appendChild(btnPromover);
        } else if (user.tipo === 'moderador') {
          const btnRebaixar = document.createElement('button');
          btnRebaixar.textContent = '⬇️ Rebaixar a Aluno';
          btnRebaixar.onclick = (e) => {
            e.stopPropagation();
            demoteUser(user);
          };
          menuOptions.appendChild(btnRebaixar);
        }
      }
      
      if (validarPermissao('excluir_usuarios')) {
        const btnExcluir = document.createElement('button');
        btnExcluir.className = 'danger';
        btnExcluir.textContent = '🗑️ Excluir';
        btnExcluir.onclick = (e) => {
          e.stopPropagation();
          deleteUser(user);
        };
        menuOptions.appendChild(btnExcluir);
      }
      
      if (menuOptions.children.length > 0) {
        gearMenu.onclick = (e) => {
          e.stopPropagation();
          const isVisible = menuOptions.style.display === 'block';
          document.querySelectorAll('.menu-options').forEach(m => m.style.display = 'none');
          menuOptions.style.display = isVisible ? 'none' : 'block';
        };
        
        card.appendChild(gearMenu);
        card.appendChild(menuOptions);
      }
    }

    const photo = document.createElement('div');
    photo.className = 'user-photo';
    
    if (user.fotoBase64) {
      const img = document.createElement('img');
      img.src = user.fotoBase64;
      img.alt = user.nome;
      photo.appendChild(img);
    } else {
      photo.textContent = user.nome.charAt(0).toUpperCase();
    }
    card.appendChild(photo);

    const title = document.createElement('div');
    title.className = 'user-title';
    title.textContent = `${user.nome} ${user.sobrenome || ''}`;
    card.appendChild(title);

    const info = document.createElement('div');
    info.style.fontSize = '0.9rem';
    info.style.color = '#0af';
    info.style.textAlign = 'center';
    info.innerHTML = `
      <div><b>Usuário:</b> ${user.usuario}</div>
      <div><b>Email:</b> ${user.email}</div>
      <div><b>Telefone:</b> ${user.telefone || user.celular || '-'}</div>
    `;
    card.appendChild(info);

    usersGrid.appendChild(card);
  });

  quizzesContainer.appendChild(usersGrid);
}

function exibirCadastrosPendentes() {
  const title = document.createElement('div');
  title.className = 'section-title';
  title.innerHTML = `<span>⏳ Cadastros Pendentes</span>`;
  quizzesContainer.appendChild(title);

  if (cadastros.length === 0) {
    quizzesContainer.innerHTML += '<p class="empty-message">Nenhum cadastro pendente.</p>';
    return;
  }
  
  const cadastrosGrid = document.createElement('div');
  cadastrosGrid.className = 'items-grid';
  
  cadastros.forEach(cadastro => {
    const card = document.createElement('div');
    card.className = 'user-card';
    
    const photo = document.createElement('div');
    photo.className = 'user-photo';
    photo.style.width = '60px';
    photo.style.height = '60px';
    photo.style.fontSize = '1.5rem';
    
    if (cadastro.fotoBase64) {
      const img = document.createElement('img');
      img.src = cadastro.fotoBase64;
      img.alt = cadastro.nome;
      photo.appendChild(img);
    } else {
      photo.textContent = cadastro.nome.charAt(0).toUpperCase();
    }
    card.appendChild(photo);
    
    const title = document.createElement('div');
    title.className = 'user-title';
    title.textContent = `${cadastro.nome} ${cadastro.sobrenome || ''} (${cadastro.usuario})`;
    card.appendChild(title);
    
    const info = document.createElement('div');
    info.style.fontSize = '0.9rem';
    info.style.color = '#0af';
    info.style.textAlign = 'center';
    info.innerHTML = `
      <div><b>Email:</b> ${cadastro.email}</div>
      <div><b>Telefone:</b> ${cadastro.telefone || cadastro.celular || '-'}</div>
      <div><b>Tipo Solicitado:</b> ${cadastro.tipoSolicitado || 'aluno'}</div>
      <div style="color: #ffa726; margin-top: 10px;"><b>⏳ AGUARDANDO APROVAÇÃO</b></div>
    `;
    card.appendChild(info);
    
    const actions = document.createElement('div');
    actions.className = 'user-actions';
    
    const btnAprovar = document.createElement('button');
    btnAprovar.textContent = '✅ Aprovar';
    btnAprovar.onclick = () => aprovarCadastro(cadastro);
    
    const btnRejeitar = document.createElement('button');
    btnRejeitar.textContent = '❌ Rejeitar';
    btnRejeitar.className = 'danger';
    btnRejeitar.onclick = () => rejeitarCadastro(cadastro);
    
    actions.appendChild(btnAprovar);
    actions.appendChild(btnRejeitar);
    card.appendChild(actions);
    cadastrosGrid.appendChild(card);
  });

  quizzesContainer.appendChild(cadastrosGrid);
}

function exibirPDFs() {
  const title = document.createElement('div');
  title.className = 'section-title';
  title.innerHTML = `
    <span>📄 Gerenciar PDFs</span>
    <div class="section-actions">
      ${validarPermissao('upload_pdf') ? '<button class="upload-btn" onclick="uploadPDF()">📤 Upload PDF</button>' : ''}
    </div>
  `;
  quizzesContainer.appendChild(title);

  if (pdfs.length === 0) {
    const empty = document.createElement('div');
    empty.className = 'empty-section';
    empty.innerHTML = `
      <h3>📄 Nenhum PDF disponível</h3>
      <p>Os PDFs enviados aparecerão aqui.</p>
      ${validarPermissao('upload_pdf') ? '<button class="upload-btn" onclick="uploadPDF()" style="margin-top: 20px;">📤 Fazer Upload</button>' : ''}
    `;
    quizzesContainer.appendChild(empty);
    return;
  }

  const pdfsGrid = document.createElement('div');
  pdfsGrid.className = 'items-grid';

  pdfs.forEach(pdf => {
    const card = criarCardPdf(pdf);
    pdfsGrid.appendChild(card);
  });

  quizzesContainer.appendChild(pdfsGrid);
}

// ============================================================================
// FUNÇÕES AUXILIARES
// ============================================================================

function mostrarMensagemSucesso(mensagem) {
  mensagemSucesso.textContent = mensagem;
  mensagemSucesso.classList.add('show');
  
  setTimeout(() => {
    mensagemSucesso.classList.remove('show');
  }, 4000);
}

function mostrarLoading(mensagem = 'Carregando...') {
  quizzesContainer.innerHTML = `<div class="loading">${mensagem}</div>`;
}

function esconderLoading() {
  const loading = document.querySelector('.loading');
  if (loading) loading.remove();
}

// ============================================================================
// EVENT LISTENERS E INICIALIZAÇÃO
// ============================================================================

document.addEventListener('DOMContentLoaded', () => {
  const fileInput = document.getElementById('fileInput');
  fileInput.addEventListener('change', handleFileUpload);
  
  const profilePhotoInput = document.getElementById('profilePhotoInput');
  profilePhotoInput.addEventListener('change', handleProfilePhotoUpload);

  criarParticulas();
});

document.addEventListener('click', (e) => {
  if (!e.target.closest('.gear-menu') && !e.target.closest('.menu-options')) {
    document.querySelectorAll('.menu-options').forEach(menu => {
      menu.style.display = 'none';
    });
  }
});

// ============================================================================
// INICIALIZAÇÃO PRINCIPAL DO SISTEMA - CORRIGIDA
// ============================================================================

(async () => {
  try {
    console.log('🚀 Iniciando Dashboard Sincronizado v5.1...');
    
    mostrarLoading('Verificando autenticação...');
    const usuarioValido = await verificarUsuarioLogado();
    if (!usuarioValido) return;
    
    mostrarLoading('Carregando dados do sistema...');
    await carregarDadosReais();
    
    mostrarLoading('Configurando interface...');
    configurarBotoesPrincipais();
    configurarTabs();
    
    exibirConteudo();
    esconderLoading();
    
    console.log('✅ Sistema inicializado com sucesso!');
    console.log('👤 Usuário:', usuarioLogado.usuario, '(' + usuarioLogado.tipo + ')');
    console.log('📊 Dados carregados:', {
      quizzes: quizzes.length,
      usuarios: users.length,
      cadastros: cadastros.length,
      pdfs: pdfs.length
    });
    
    mostrarMensagemSucesso(`✨ Bem-vindo, ${usuarioLogado.nome}! Sistema sincronizado com o backend.`);
    
  } catch (error) {
    console.error('❌ Erro na inicialização:', error);
    quizzesContainer.innerHTML = '<div class="error">Erro ao carregar o sistema. Redirecionando para login...</div>';
    setTimeout(() => {
      window.location.href = '/';
    }, 3000);
  }
})();

console.log('🎯 DASHBOARD SINCRONIZADO CARREGADO - v5.1 Sistema Real!');

</script>
</body>
</html>